<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL | CtrlCVer</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/6.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <link rel="stylesheet" href="/css/index.css">
    <meta name="description" content="孙文豪大魔王">
    
    <link rel="preload" href="/assets/css/0.styles.84492279.css" as="style"><link rel="preload" href="/assets/js/app.347fa917.js" as="script"><link rel="preload" href="/assets/js/4.4e440976.js" as="script"><link rel="preload" href="/assets/js/3.4c8c30ea.js" as="script"><link rel="prefetch" href="/assets/js/10.1230c4be.js"><link rel="prefetch" href="/assets/js/11.daeaf548.js"><link rel="prefetch" href="/assets/js/12.abede0ae.js"><link rel="prefetch" href="/assets/js/13.cb62a723.js"><link rel="prefetch" href="/assets/js/14.5375bc4a.js"><link rel="prefetch" href="/assets/js/15.ffb73a9c.js"><link rel="prefetch" href="/assets/js/16.6be16dba.js"><link rel="prefetch" href="/assets/js/17.3879182a.js"><link rel="prefetch" href="/assets/js/18.04083c0b.js"><link rel="prefetch" href="/assets/js/19.ee44a025.js"><link rel="prefetch" href="/assets/js/2.3a3bb906.js"><link rel="prefetch" href="/assets/js/20.bdce0031.js"><link rel="prefetch" href="/assets/js/21.b9bf7143.js"><link rel="prefetch" href="/assets/js/22.aadd746b.js"><link rel="prefetch" href="/assets/js/23.d590bbfb.js"><link rel="prefetch" href="/assets/js/24.72023ebd.js"><link rel="prefetch" href="/assets/js/25.dd4e2abc.js"><link rel="prefetch" href="/assets/js/26.d2b37904.js"><link rel="prefetch" href="/assets/js/27.971418ab.js"><link rel="prefetch" href="/assets/js/28.779a0681.js"><link rel="prefetch" href="/assets/js/29.246ef370.js"><link rel="prefetch" href="/assets/js/30.ffc51d63.js"><link rel="prefetch" href="/assets/js/31.6d4fb3a7.js"><link rel="prefetch" href="/assets/js/32.0f4e411c.js"><link rel="prefetch" href="/assets/js/33.11a7d2af.js"><link rel="prefetch" href="/assets/js/34.e7403a40.js"><link rel="prefetch" href="/assets/js/35.92937b0a.js"><link rel="prefetch" href="/assets/js/36.9f52b8c7.js"><link rel="prefetch" href="/assets/js/37.193fb1cc.js"><link rel="prefetch" href="/assets/js/38.33e3fa35.js"><link rel="prefetch" href="/assets/js/39.1b9c5402.js"><link rel="prefetch" href="/assets/js/40.4ae4ec73.js"><link rel="prefetch" href="/assets/js/41.93514908.js"><link rel="prefetch" href="/assets/js/42.79934fb7.js"><link rel="prefetch" href="/assets/js/43.6be9e89a.js"><link rel="prefetch" href="/assets/js/44.cf8d93d5.js"><link rel="prefetch" href="/assets/js/45.89850dfb.js"><link rel="prefetch" href="/assets/js/46.c9bf838d.js"><link rel="prefetch" href="/assets/js/47.d009214c.js"><link rel="prefetch" href="/assets/js/48.f303128c.js"><link rel="prefetch" href="/assets/js/49.a002314e.js"><link rel="prefetch" href="/assets/js/5.baec3451.js"><link rel="prefetch" href="/assets/js/50.bf708037.js"><link rel="prefetch" href="/assets/js/51.a0931ba6.js"><link rel="prefetch" href="/assets/js/52.d828c50a.js"><link rel="prefetch" href="/assets/js/53.319606bc.js"><link rel="prefetch" href="/assets/js/54.45b73705.js"><link rel="prefetch" href="/assets/js/55.19e29602.js"><link rel="prefetch" href="/assets/js/56.70a7339c.js"><link rel="prefetch" href="/assets/js/57.24bae8ee.js"><link rel="prefetch" href="/assets/js/58.b9e501fa.js"><link rel="prefetch" href="/assets/js/59.5741b163.js"><link rel="prefetch" href="/assets/js/6.faab7e15.js"><link rel="prefetch" href="/assets/js/60.55c05a7e.js"><link rel="prefetch" href="/assets/js/61.66739ddc.js"><link rel="prefetch" href="/assets/js/62.984ff248.js"><link rel="prefetch" href="/assets/js/63.198b0614.js"><link rel="prefetch" href="/assets/js/64.44df42dc.js"><link rel="prefetch" href="/assets/js/65.835f260b.js"><link rel="prefetch" href="/assets/js/66.b01fd1a5.js"><link rel="prefetch" href="/assets/js/67.3e990aa1.js"><link rel="prefetch" href="/assets/js/68.3bff67c3.js"><link rel="prefetch" href="/assets/js/69.c77e5194.js"><link rel="prefetch" href="/assets/js/7.1e0b6ef9.js"><link rel="prefetch" href="/assets/js/70.990cc3f7.js"><link rel="prefetch" href="/assets/js/71.faf1e578.js"><link rel="prefetch" href="/assets/js/72.bf80a7aa.js"><link rel="prefetch" href="/assets/js/73.28855af5.js"><link rel="prefetch" href="/assets/js/74.575cab52.js"><link rel="prefetch" href="/assets/js/75.9fbc678e.js"><link rel="prefetch" href="/assets/js/76.aefd2222.js"><link rel="prefetch" href="/assets/js/77.29024e8c.js"><link rel="prefetch" href="/assets/js/78.1a261541.js"><link rel="prefetch" href="/assets/js/79.7f221adf.js"><link rel="prefetch" href="/assets/js/8.52cec024.js"><link rel="prefetch" href="/assets/js/80.a25bdaa1.js"><link rel="prefetch" href="/assets/js/81.78c287ce.js"><link rel="prefetch" href="/assets/js/9.6965887d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.84492279.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/2.png" alt="CtrlCVer" class="logo"> <span class="site-name can-hide">CtrlCVer</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/数据库/MySQL.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/pages/数据库/Redis.html" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue" class="dropdown-title"><span class="title">Vue</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vue" class="mobile-dropdown-title"><span class="title">Vue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/Vue/Vue-loading动态加载.html" class="nav-link">
  Vue-loading动态加载
</a></li><li class="dropdown-item"><!----> <a href="/pages/Vue/Vue项目用axios做request封装.html" class="nav-link">
  Vue项目用axios做request封装
</a></li><li class="dropdown-item"><!----> <a href="/pages/Vue/前端踩坑之路.html" class="nav-link">
  前端踩坑之路
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="SpringBoot" class="dropdown-title"><span class="title">SpringBoot</span> <span class="arrow down"></span></button> <button type="button" aria-label="SpringBoot" class="mobile-dropdown-title"><span class="title">SpringBoot</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/aop面向切面编程.html" class="nav-link">
  aop面向切面编程
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/Cron表达式.html" class="nav-link">
  Cron表达式
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/issue3.html" class="nav-link">
  issue3
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/Listener监听器.html" class="nav-link">
  Listener监听器
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/Mybatis 动态SQL.html" class="nav-link">
  Mybatis 动态SQL
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/Mybatis.html" class="nav-link">
  Mybatis
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/mybatis和spring整合.html" class="nav-link">
  mybatis和spring整合
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/Mybatis缓存机制.html" class="nav-link">
  Mybatis缓存机制
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/session之 HttpSessionActivation.html" class="nav-link">
  session之 HttpSessionActivation
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/springboot+vue部署后出现springboot后端部分页面404.html" class="nav-link">
  springboot+vue部署后出现springboot后端部分页面404
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/springboot.html" class="nav-link">
  springboot
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/SpringMVC介绍.html" class="nav-link">
  SpringMVC介绍
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/springmvc重定向和请求转发操作.html" class="nav-link">
  springmvc重定向和请求转发操作
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/Spring介绍.html" class="nav-link">
  Spring介绍
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/SSM整合开发.html" class="nav-link">
  SSM整合开发
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/url-pattern设置.html" class="nav-link">
  url-pattern设置
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/web开发.html" class="nav-link">
  web开发
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/yaml.html" class="nav-link">
  yaml
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/单元测试.html" class="nav-link">
  单元测试
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/启动原理.html" class="nav-link">
  启动原理
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/嵌入式servlet服务器.html" class="nav-link">
  嵌入式servlet服务器
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/异常，拦截器....html" class="nav-link">
  异常，拦截器...
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/执行流程分析.html" class="nav-link">
  执行流程分析
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/指标监控.html" class="nav-link">
  指标监控
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/数据访问.html" class="nav-link">
  数据访问
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/注意.html" class="nav-link">
  注意
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/注解.html" class="nav-link">
  注解
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/注解方式注入.html" class="nav-link">
  注解方式注入
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/源码分析.html" class="nav-link">
  源码分析
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/高级特性.html" class="nav-link">
  高级特性
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="SpringCloud" class="dropdown-title"><span class="title">SpringCloud</span> <span class="arrow down"></span></button> <button type="button" aria-label="SpringCloud" class="mobile-dropdown-title"><span class="title">SpringCloud</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/Eureka.html" class="nav-link">
  Eureka
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/Gateway.html" class="nav-link">
  Gateway
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/Hystrix断路器.html" class="nav-link">
  Hystrix断路器
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/nacos-config.html" class="nav-link">
  nacos-config
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/nacos.html" class="nav-link">
  nacos
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/nacos集群和持久化配置.html" class="nav-link">
  nacos集群和持久化配置
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/OpenFeign ISsue.html" class="nav-link">
  OpenFeign ISsue
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/OpenFeign-issue.html" class="nav-link">
  OpenFeign-issue
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/OpenFeign服务接口调用.html" class="nav-link">
  OpenFeign服务接口调用
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/question.html" class="nav-link">
  question
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/seata.html" class="nav-link">
  seata
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/security.html" class="nav-link">
  security
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/sentinel.html" class="nav-link">
  sentinel
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/Sentinel实现熔断与限流.html" class="nav-link">
  Sentinel实现熔断与限流
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/Spring Cloud Ribbon.html" class="nav-link">
  Spring Cloud Ribbon
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/spring-cloud-stream.html" class="nav-link">
  spring-cloud-stream
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/stream3.2学习.html" class="nav-link">
  stream3.2学习
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/zookeeper.html" class="nav-link">
  zookeeper
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/配置中心.html" class="nav-link">
  配置中心
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JVM" class="dropdown-title"><span class="title">JVM</span> <span class="arrow down"></span></button> <button type="button" aria-label="JVM" class="mobile-dropdown-title"><span class="title">JVM</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/JVM/JVM.html" class="nav-link">
  JVM
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JUC" class="dropdown-title"><span class="title">JUC</span> <span class="arrow down"></span></button> <button type="button" aria-label="JUC" class="mobile-dropdown-title"><span class="title">JUC</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/JUC/Atomic原子操作类.html" class="nav-link">
  Atomic原子操作类
</a></li><li class="dropdown-item"><!----> <a href="/pages/JUC/CAS.html" class="nav-link">
  CAS
</a></li><li class="dropdown-item"><!----> <a href="/pages/JUC/Java内存模型JMM.html" class="nav-link">
  Java内存模型JMM
</a></li><li class="dropdown-item"><!----> <a href="/pages/JUC/Java对象内存布局和对象头.html" class="nav-link">
  Java对象内存布局和对象头
</a></li><li class="dropdown-item"><!----> <a href="/pages/JUC/synchronized.html" class="nav-link">
  synchronized
</a></li><li class="dropdown-item"><!----> <a href="/pages/JUC/ThreadLocl.html" class="nav-link">
  ThreadLocl
</a></li><li class="dropdown-item"><!----> <a href="/pages/JUC/Thread、ThreadLocal、ThreadLocalMap.html" class="nav-link">
  Thread、ThreadLocal、ThreadLocalMap
</a></li><li class="dropdown-item"><!----> <a href="/pages/JUC/volatile.html" class="nav-link">
  volatile
</a></li><li class="dropdown-item"><!----> <a href="/pages/JUC/多线程锁.html" class="nav-link">
  多线程锁
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Project" class="dropdown-title"><span class="title">Project</span> <span class="arrow down"></span></button> <button type="button" aria-label="Project" class="mobile-dropdown-title"><span class="title">Project</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/Project/clash部署至服务器，提供“上网”服务.html" class="nav-link">
  clash部署至服务器，提供“上网”服务
</a></li><li class="dropdown-item"><!----> <a href="/pages/Project/Oauth2.html" class="nav-link">
  Oauth2
</a></li><li class="dropdown-item"><!----> <a href="/pages/Project/SSE+Flux.html" class="nav-link">
  SSE+Flux
</a></li><li class="dropdown-item"><!----> <a href="/pages/Project/Unicloud 阿里云服务器作图床.html" class="nav-link">
  Unicloud 阿里云服务器作图床
</a></li><li class="dropdown-item"><!----> <a href="/pages/Project/内网穿透技术初探.html" class="nav-link">
  内网穿透技术初探
</a></li><li class="dropdown-item"><!----> <a href="/pages/Project/微信订阅号开发.html" class="nav-link">
  微信订阅号开发
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="课程" class="dropdown-title"><span class="title">课程</span> <span class="arrow down"></span></button> <button type="button" aria-label="课程" class="mobile-dropdown-title"><span class="title">课程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/课程/操作系统.html" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/pages/课程/计算机组成与原理.html" class="nav-link">
  计算机组成与原理
</a></li><li class="dropdown-item"><!----> <a href="/pages/课程/计算机网络.html" class="nav-link">
  计算机网络
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="机器视觉" class="dropdown-title"><span class="title">机器视觉</span> <span class="arrow down"></span></button> <button type="button" aria-label="机器视觉" class="mobile-dropdown-title"><span class="title">机器视觉</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/机器视觉/RTMPose.html" class="nav-link">
  RTMPose
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/sunwenhaopro" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/数据库/MySQL.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/pages/数据库/Redis.html" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue" class="dropdown-title"><span class="title">Vue</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vue" class="mobile-dropdown-title"><span class="title">Vue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/Vue/Vue-loading动态加载.html" class="nav-link">
  Vue-loading动态加载
</a></li><li class="dropdown-item"><!----> <a href="/pages/Vue/Vue项目用axios做request封装.html" class="nav-link">
  Vue项目用axios做request封装
</a></li><li class="dropdown-item"><!----> <a href="/pages/Vue/前端踩坑之路.html" class="nav-link">
  前端踩坑之路
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="SpringBoot" class="dropdown-title"><span class="title">SpringBoot</span> <span class="arrow down"></span></button> <button type="button" aria-label="SpringBoot" class="mobile-dropdown-title"><span class="title">SpringBoot</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/aop面向切面编程.html" class="nav-link">
  aop面向切面编程
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/Cron表达式.html" class="nav-link">
  Cron表达式
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/issue3.html" class="nav-link">
  issue3
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/Listener监听器.html" class="nav-link">
  Listener监听器
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/Mybatis 动态SQL.html" class="nav-link">
  Mybatis 动态SQL
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/Mybatis.html" class="nav-link">
  Mybatis
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/mybatis和spring整合.html" class="nav-link">
  mybatis和spring整合
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/Mybatis缓存机制.html" class="nav-link">
  Mybatis缓存机制
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/session之 HttpSessionActivation.html" class="nav-link">
  session之 HttpSessionActivation
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/springboot+vue部署后出现springboot后端部分页面404.html" class="nav-link">
  springboot+vue部署后出现springboot后端部分页面404
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/springboot.html" class="nav-link">
  springboot
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/SpringMVC介绍.html" class="nav-link">
  SpringMVC介绍
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/springmvc重定向和请求转发操作.html" class="nav-link">
  springmvc重定向和请求转发操作
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/Spring介绍.html" class="nav-link">
  Spring介绍
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/SSM整合开发.html" class="nav-link">
  SSM整合开发
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/url-pattern设置.html" class="nav-link">
  url-pattern设置
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/web开发.html" class="nav-link">
  web开发
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/yaml.html" class="nav-link">
  yaml
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/单元测试.html" class="nav-link">
  单元测试
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/启动原理.html" class="nav-link">
  启动原理
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/嵌入式servlet服务器.html" class="nav-link">
  嵌入式servlet服务器
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/异常，拦截器....html" class="nav-link">
  异常，拦截器...
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/执行流程分析.html" class="nav-link">
  执行流程分析
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/指标监控.html" class="nav-link">
  指标监控
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/数据访问.html" class="nav-link">
  数据访问
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/注意.html" class="nav-link">
  注意
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/注解.html" class="nav-link">
  注解
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/注解方式注入.html" class="nav-link">
  注解方式注入
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/源码分析.html" class="nav-link">
  源码分析
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringBoot/高级特性.html" class="nav-link">
  高级特性
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="SpringCloud" class="dropdown-title"><span class="title">SpringCloud</span> <span class="arrow down"></span></button> <button type="button" aria-label="SpringCloud" class="mobile-dropdown-title"><span class="title">SpringCloud</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/Eureka.html" class="nav-link">
  Eureka
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/Gateway.html" class="nav-link">
  Gateway
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/Hystrix断路器.html" class="nav-link">
  Hystrix断路器
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/nacos-config.html" class="nav-link">
  nacos-config
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/nacos.html" class="nav-link">
  nacos
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/nacos集群和持久化配置.html" class="nav-link">
  nacos集群和持久化配置
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/OpenFeign ISsue.html" class="nav-link">
  OpenFeign ISsue
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/OpenFeign-issue.html" class="nav-link">
  OpenFeign-issue
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/OpenFeign服务接口调用.html" class="nav-link">
  OpenFeign服务接口调用
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/question.html" class="nav-link">
  question
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/seata.html" class="nav-link">
  seata
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/security.html" class="nav-link">
  security
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/sentinel.html" class="nav-link">
  sentinel
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/Sentinel实现熔断与限流.html" class="nav-link">
  Sentinel实现熔断与限流
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/Spring Cloud Ribbon.html" class="nav-link">
  Spring Cloud Ribbon
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/spring-cloud-stream.html" class="nav-link">
  spring-cloud-stream
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/stream3.2学习.html" class="nav-link">
  stream3.2学习
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/zookeeper.html" class="nav-link">
  zookeeper
</a></li><li class="dropdown-item"><!----> <a href="/pages/SpringCloud/配置中心.html" class="nav-link">
  配置中心
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JVM" class="dropdown-title"><span class="title">JVM</span> <span class="arrow down"></span></button> <button type="button" aria-label="JVM" class="mobile-dropdown-title"><span class="title">JVM</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/JVM/JVM.html" class="nav-link">
  JVM
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JUC" class="dropdown-title"><span class="title">JUC</span> <span class="arrow down"></span></button> <button type="button" aria-label="JUC" class="mobile-dropdown-title"><span class="title">JUC</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/JUC/Atomic原子操作类.html" class="nav-link">
  Atomic原子操作类
</a></li><li class="dropdown-item"><!----> <a href="/pages/JUC/CAS.html" class="nav-link">
  CAS
</a></li><li class="dropdown-item"><!----> <a href="/pages/JUC/Java内存模型JMM.html" class="nav-link">
  Java内存模型JMM
</a></li><li class="dropdown-item"><!----> <a href="/pages/JUC/Java对象内存布局和对象头.html" class="nav-link">
  Java对象内存布局和对象头
</a></li><li class="dropdown-item"><!----> <a href="/pages/JUC/synchronized.html" class="nav-link">
  synchronized
</a></li><li class="dropdown-item"><!----> <a href="/pages/JUC/ThreadLocl.html" class="nav-link">
  ThreadLocl
</a></li><li class="dropdown-item"><!----> <a href="/pages/JUC/Thread、ThreadLocal、ThreadLocalMap.html" class="nav-link">
  Thread、ThreadLocal、ThreadLocalMap
</a></li><li class="dropdown-item"><!----> <a href="/pages/JUC/volatile.html" class="nav-link">
  volatile
</a></li><li class="dropdown-item"><!----> <a href="/pages/JUC/多线程锁.html" class="nav-link">
  多线程锁
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Project" class="dropdown-title"><span class="title">Project</span> <span class="arrow down"></span></button> <button type="button" aria-label="Project" class="mobile-dropdown-title"><span class="title">Project</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/Project/clash部署至服务器，提供“上网”服务.html" class="nav-link">
  clash部署至服务器，提供“上网”服务
</a></li><li class="dropdown-item"><!----> <a href="/pages/Project/Oauth2.html" class="nav-link">
  Oauth2
</a></li><li class="dropdown-item"><!----> <a href="/pages/Project/SSE+Flux.html" class="nav-link">
  SSE+Flux
</a></li><li class="dropdown-item"><!----> <a href="/pages/Project/Unicloud 阿里云服务器作图床.html" class="nav-link">
  Unicloud 阿里云服务器作图床
</a></li><li class="dropdown-item"><!----> <a href="/pages/Project/内网穿透技术初探.html" class="nav-link">
  内网穿透技术初探
</a></li><li class="dropdown-item"><!----> <a href="/pages/Project/微信订阅号开发.html" class="nav-link">
  微信订阅号开发
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="课程" class="dropdown-title"><span class="title">课程</span> <span class="arrow down"></span></button> <button type="button" aria-label="课程" class="mobile-dropdown-title"><span class="title">课程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/课程/操作系统.html" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/pages/课程/计算机组成与原理.html" class="nav-link">
  计算机组成与原理
</a></li><li class="dropdown-item"><!----> <a href="/pages/课程/计算机网络.html" class="nav-link">
  计算机网络
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="机器视觉" class="dropdown-title"><span class="title">机器视觉</span> <span class="arrow down"></span></button> <button type="button" aria-label="机器视觉" class="mobile-dropdown-title"><span class="title">机器视觉</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/机器视觉/RTMPose.html" class="nav-link">
  RTMPose
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/sunwenhaopro" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/pages/数据库/MySQL.html" class="active sidebar-link">MySQL</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#sql查询语句的执行流程" class="sidebar-link">SQL查询语句的执行流程</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#sql数据如何存储" class="sidebar-link">SQL数据如何存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#表空间文件的结构" class="sidebar-link">表空间文件的结构</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#innodb行格式" class="sidebar-link">InnoDB行格式</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#compact行格式" class="sidebar-link">COMPACT行格式</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#varchar中n最大是多少" class="sidebar-link">VarChar中n最大是多少</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#行溢出怎么处理" class="sidebar-link">行溢出怎么处理</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#页空间结构" class="sidebar-link">页空间结构</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#mysql索引" class="sidebar-link">MySQL索引</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#索引分类" class="sidebar-link">索引分类</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#索引的数据结构" class="sidebar-link">索引的数据结构</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#mysql为什么使用b-tree" class="sidebar-link">MySQL为什么使用B+tree</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#索引优化" class="sidebar-link">索引优化</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#索引下推" class="sidebar-link">索引下推</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#回表" class="sidebar-link">回表</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#覆盖索引" class="sidebar-link">覆盖索引</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#索引失效" class="sidebar-link">索引失效</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#count操作" class="sidebar-link">Count操作</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#mysql事务" class="sidebar-link">MySQL事务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#事物的特性" class="sidebar-link">事物的特性</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#并行事务" class="sidebar-link">并行事务</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#事务的隔离级别" class="sidebar-link">事务的隔离级别</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#mvcc" class="sidebar-link">MVCC</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#readview在mvcc如何工作" class="sidebar-link">ReadView在MVCC如何工作</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#可重复读控制流程" class="sidebar-link">可重复读控制流程</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#读提交控制流程" class="sidebar-link">读提交控制流程</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#总结" class="sidebar-link">总结</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#mysql锁事" class="sidebar-link">MySQL锁事</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#mysql有哪些锁" class="sidebar-link">MySQL有哪些锁</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#mysql锁的特征" class="sidebar-link">MySQL锁的特征</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#mysql加锁时机" class="sidebar-link">MySQL加锁时机</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#mysql日志" class="sidebar-link">MySQL日志</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#undo-log" class="sidebar-link">Undo Log</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#buffer-pool" class="sidebar-link">Buffer Pool</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#redo-log" class="sidebar-link">Redo Log</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#bin-log" class="sidebar-link">Bin Log</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#两阶段提交" class="sidebar-link">两阶段提交</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#bufferpool" class="sidebar-link">BufferPool</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#概念" class="sidebar-link">概念</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#结构组成" class="sidebar-link">结构组成</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#如何管理空闲页" class="sidebar-link">如何管理空闲页</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#如何管理脏页" class="sidebar-link">如何管理脏页</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#buffer-pool结构总结" class="sidebar-link">Buffer Pool结构总结</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#如何提高缓存命中率" class="sidebar-link">如何提高缓存命中率</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#脏页的刷盘时机" class="sidebar-link">脏页的刷盘时机</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#mysql主从复制" class="sidebar-link">MySQL主从复制</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#mysql数据迁移" class="sidebar-link">MySQL数据迁移</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#需求背景" class="sidebar-link">需求背景</a></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#方案" class="sidebar-link">方案</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#mysql扩容方案" class="sidebar-link">MySQL扩容方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#免迁移扩容" class="sidebar-link">免迁移扩容</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/数据库/MySQL.html#相关连接" class="sidebar-link">相关连接</a></li></ul></li><li><a href="/pages/数据库/Redis.html" class="sidebar-link">Redis</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mysql"><a href="#mysql" class="header-anchor">#</a> MySQL</h1> <h2 id="sql查询语句的执行流程"><a href="#sql查询语句的执行流程" class="header-anchor">#</a> SQL查询语句的执行流程</h2> <img src="/assets/img/ae505d025b965d1c06e2da4073b7b4c9.ae505d02.png" alt="img"> <ol><li>连接器：建立tcp连接，身份认证，维护连接</li> <li>查询缓存：语句如果命中缓存就直接返回，否则继续执行，MySQL8.0移除</li> <li>解析SQL：语法分析，词法分析，建立语法树</li> <li>预处理：检查表和字段是否存在，* 拓展为表上所有列</li> <li>优化：SQL语句优化，制定成本最小的执行计划</li> <li>执行：执行计划，从存储引擎查找数据</li> <li>返回数据：返回给客户端和更新缓存（8.0以废除缓存）</li></ol> <h2 id="sql数据如何存储"><a href="#sql数据如何存储" class="header-anchor">#</a> SQL数据如何存储</h2> <h3 id="表空间文件的结构"><a href="#表空间文件的结构" class="header-anchor">#</a> 表空间文件的结构</h3> <blockquote><p>表空间由段，区，页，行组成</p></blockquote> <img src="/assets/img/4f488db1d09ebe8ba7b8266948dc9f42.4f488db1.png" alt="img"> <ol><li>行：表中的数据都是一行一行记录的</li> <li>页：考虑到效率问题，数据库以页为单位进行读写，默认每个页大小是16kb。</li> <li>区：每个区的大小为 1MB，对于 16KB 的页来说，连续的 64 个页会被划为一个区，这样就使得链表中相邻的页的物理位置也相邻，就能使用顺序 I/O ，避免了大量的随机IO</li> <li>段：表空间是由各个段（segment）组成的，段是由多个区（extent）组成的。段一般分为==数据段、索引段和回滚段==等。</li></ol> <h3 id="innodb行格式"><a href="#innodb行格式" class="header-anchor">#</a> InnoDB行格式</h3> <ul><li>Redundant 是很古老的行格式了， MySQL 5.0 版本之前用的行格式，现在基本没人用了。</li> <li>==Compact== 是一种紧凑的行格式，设计的初衷就是为了让一个数据页中可以存放更多的行记录，从 MySQL 5.1 版本之后，行格式默认设置成 Compact。</li> <li>Dynamic 和 Compressed 两个都是紧凑的行格式，它们的行格式都和 Compact 差不多，因为都是基于 Compact 改进一点东西。从 MySQL==5.7== 版本之后，==默认使用 Dynamic== 行格式。</li></ul> <h3 id="compact行格式"><a href="#compact行格式" class="header-anchor">#</a> COMPACT行格式</h3> <img src="/assets/img/d8b65567264d22c9a32032f62a023366.d8b65567.png" alt="img"> <h4 id="变长字段长度列表"><a href="#变长字段长度列表" class="header-anchor">#</a> ==变长字段长度列表==</h4> <p>这些变长字段的真实数据占用的字节数会按照列的顺序**==逆序存放==**，主要是因为「记录头信息」中指向下一个记录的指针，指向的是==下一条记录的「记录头信息」和「真实数据」之间的位置==，这样的好处是向左读就是记录额外信息，向右读就是真实数据，比较方便。因为这样可以==<strong>使得位置靠前的记录的真实数据和数据对应的字段长度信息可以同时在一个 CPU Cache Line 中，这样就可以提高 CPU Cache 的命中率</strong>。（对称记录）==</p> <h4 id="null值列表"><a href="#null值列表" class="header-anchor">#</a> ==NULL值列表==</h4> <p>如果存在为NULL的的字段，那么这样的字段都会对应一个二进制位，并且也是按照列的先后进行==逆序排列==，并且必须是==整数字节==，不足的话==高位补零==</p> <ul><li>bit位为1，则值为null</li> <li>bit为为0，则值非null</li></ul> <p>NULL值列表只有在字段定义存在NULL值的时候有。</p> <h4 id="记录头信息"><a href="#记录头信息" class="header-anchor">#</a> ==记录头信息==</h4> <ul><li>==delete_mask== ：标识此条数据是否被删除。从这里可以知道，我们执行 detele 删除记录的时候，并不会真正的删除记录，只是将这个记录的 delete_mask 标记为 1。</li> <li>==next_record==：下一条记录的位置。从这里可以知道，记录与记录之间是通过链表组织的。在前面我也提到了，指向的是下一条记录的「记录头信息」和「真实数据」之间的位置，这样的好处是向左读就是记录头信息，向右读就是真实数据，比较方便。</li> <li>==record_type==：表示当前记录的类型，0表示普通记录，1表示B+树非叶子节点记录，2表示最小记录，3表示最大记录</li></ul> <h4 id="记录的真实数据"><a href="#记录的真实数据" class="header-anchor">#</a> ==记录的真实数据==</h4> <p>记录真实数据部分除了我们定义的字段，还有三个隐藏字段，分别为：==row_id、trx_id、roll_pointer==</p> <ul><li>row_id:表没有定义主键和约束列，数据库自动生成的用于构建的唯一==自增索引字段==，==6个字节==大小；如果定义了上述键，则不存在该字段，所以该字段非必须</li> <li>trx_id: 事务id，那个事务生成的，必须，==6个字节==</li> <li>roll_pointer: 上一个版本的指针，必须，==7个字节==</li></ul> <h3 id="varchar中n最大是多少"><a href="#varchar中n最大是多少" class="header-anchor">#</a> VarChar中n最大是多少</h3> <p>MySQL 规定除了 TEXT、BLOBs 这种大对象类型之外，其他所有的列（不包括隐藏列和记录头信息）占用的字节长度加起来不能超过 ==65535== 个字节。</p> <p>根据行的组成可以知道影响因素：可变字段，null值字段，值，字符集</p> <p>ascii字符集（1）：65535- 1（null字段）-2（可变字段长度列表）= ==65532==</p> <p>utf-8字符集(1-4)：（65535-1-2）/ 3= ==21833==</p> <h3 id="行溢出怎么处理"><a href="#行溢出怎么处理" class="header-anchor">#</a> 行溢出怎么处理</h3> <p>一个页的大小是16kb，就是16384字节，一个varchar最多可以存储65532字节，对于大对象TEXT，BLOB可能更多，一个页可能存不了一条记录，这个时候就会发生行溢出，多的数据会转存到==溢出页==.</p> <p>发生行溢出后，==行记录的真实数据会存一部分数据，并用20字节存储指向溢出页位置的地址==（姑且称为==半溢出==）；==Compressed 和 Dynamic 这两个行格式会不存数据，只存一个地址指针==（姑且称为==全溢出==）。</p> <h3 id="页空间结构"><a href="#页空间结构" class="header-anchor">#</a> 页空间结构</h3> <img src="/assets/img/99ff3af492284d9e34c424d678b2c289.99ff3af4.png" alt="img"> <img src="/assets/img/2c90fe4cb6723c7ff3c2d6712fc42137.2c90fe4c.png" alt="img"> <p>数据页中的记录按照==主键顺序组成单向链表==</p> <p>页目录起到记录索引的作用，能够快速定位</p> <img src="/assets/img/77c9c457c907f3c77e7c5d73f66cd540.77c9c457.png" alt="img"> <img src="/assets/img/7c635d682bd3cdc421bb9eea33a5a413.3e20f07e.png" alt="图片"> <h2 id="mysql索引"><a href="#mysql索引" class="header-anchor">#</a> MySQL索引</h2> <h3 id="索引分类"><a href="#索引分类" class="header-anchor">#</a> 索引分类</h3> <ul><li>按「==数据结构==」分类：<strong>B+tree索引、Hash索引、Full-text索引</strong>。</li> <li>按「==物理存储==」分类：<strong>聚簇索引（主键索引）、二级索引（辅助索引）</strong>。</li> <li>按「==字段特性==」分类：<strong>主键索引、唯一索引、普通索引、前缀索引</strong>。</li> <li>按「==字段个数==」分类：<strong>单列索引、联合索引</strong>。（联合索引可以看成一个二级索引，只不过这个索引是多个字段拼接而来的）</li></ul> <img src="/assets/img/btree.drawio.28821a85.png" alt="主键索引 B+Tree"> <img src="/assets/img/index-btree.drawio.410da901.png" alt="二级索引 B+Tree"> <img src="/assets/img/index2.b533f671.png" alt="联合索引"> <h3 id="索引的数据结构"><a href="#索引的数据结构" class="header-anchor">#</a> 索引的数据结构</h3> <p>索引采用的是B+树存储</p> <ol><li>B tree
B+树只在叶子节点存储数据，而B树的非叶子节点也存储数据，相同IO下能查询出更多的数据
同时B+树叶子节点之间采用双向链表连接，更适合顺序查询</li> <li>二叉树
二叉树搜索复杂度log2N，B+tree根据节点允许的最大子节点个数m其复杂度是logmN，一般m大于100对于千万级数据来说B+树高度不过3-4层，而二叉树非常高了，每高一层就代表多一次磁盘IO</li> <li>Hash
Hash对于等值查询很有优势，但是难以做到范围查询</li></ol> <h3 id="mysql为什么使用b-tree"><a href="#mysql为什么使用b-tree" class="header-anchor">#</a> MySQL为什么使用B+tree</h3> <p>要设计一个 MySQL 的索引数据结构，不仅仅考虑数据结构==增删改==的时间复杂度，更重要的是要考虑==磁盘 I/0== 的操作次数。因为索引和记录都是存放在硬盘，硬盘是一个非常慢的存储设备，我们在查询数据的时候，最好能在尽可能少的磁盘 I/0 的操作次数内完成。</p> <p>二分查找树虽然是一个天然的二分结构，能很好的利用二分查找快速定位数据，但是它存在一种极端的情况，每当插入的元素都是树内最大的元素，就会导致==二分查找树退化成一个链表==，此时查询复杂度就会从 O(logn)降低为 O(n)。</p> <p>为了解决二分查找树退化成链表的问题，就出现了自平衡二叉树，保证了查询操作的时间复杂度就会一直维持在 O(logn) 。但是它本质上还是一个二叉树，每个节点只能有 2 个子节点，随着元素的增多，==树的高度会越来越高==。</p> <p>而树的高度决定于磁盘 I/O 操作的次数，因为树是存储在磁盘中的，访问每个节点，都对应一次磁盘 I/O 操作，也就是说树的高度就等于每次查询数据时磁盘 IO 操作的次数，所以树的高度越高，就会影响查询性能。</p> <p>B 树和 B+ 都是通过多叉树的方式，会将树的高度变矮，所以这两个数据结构非常适合检索存于磁盘中的数据。</p> <p>但是 MySQL 默认的存储引擎 InnoDB 采用的是 B+ 作为索引的数据结构，原因有：</p> <ul><li>B+ 树的非叶子节点不存放实际的记录数据，仅存放索引，因此数据量相同的情况下，相比存储即存索引又存记录的 B 树，B+树的非叶子节点可以存放更多的索引，因此 B+ 树可以比 B 树更「矮胖」，查询底层节点的磁盘 I/O次数会更少。</li> <li>B+ 树有大量的冗余节点（所有非叶子节点都是冗余索引），这些冗余索引让 B+ 树在插入、删除的效率都更高，比如删除根节点的时候，不会像 B 树那样会发生复杂的树的变化；</li> <li>B+ 树叶子节点之间用链表连接了起来，有利于范围查询，而 B 树要实现范围查询，因此只能通过树的遍历来完成范围查询，这会涉及多个节点的磁盘 I/O 操作，范围查询效率不如 B+ 树。</li></ul> <ol><li></li></ol> <h3 id="索引优化"><a href="#索引优化" class="header-anchor">#</a> 索引优化</h3> <ol><li><p><strong>前缀索引优化</strong>
某个字段字符串的前几个字符建立索引，这样可以减小索引字段的大小，增加一个索引页中索引的数量，间接提高查询速度。但是前缀索引无法作为覆盖索引，order by也无法使用前缀索引</p></li> <li><p><strong>索引覆盖优化</strong>
从二级索引中查询的到数据，避免回表操作</p></li> <li><p><strong>主键索引最好自增</strong></p> <p>每次插入数据都是追加操作，不需要重新移动数据，调整树的结构，如果使用非自增主键可能在插入数据的时候引发页分裂和内存碎片，导致结构不紧凑，影响查询效率</p></li> <li><p><strong>索引设置为 Not Null</strong></p> <p>索引列存在 NULL 就会导致优化器在做索引选择的时候更加复杂，更加难以优化，因为可为 NULL 的列会使索引、索引统计和值比较都更复杂，比如进行索引统计时，count 会省略值为NULL 的行。</p> <p>NULL 值是一个没意义的值，但是它会占用物理空间</p></li> <li><p><strong>防止索引失效</strong></p> <p>All（全表扫描）；</p> <p>index（全索引扫描）；</p> <p>range（索引范围扫描）；</p> <p>ref（非唯一索引扫描）；</p> <p>eq_ref（唯一索引扫描）；</p> <p>const（结果只有一条的主键或唯一索引扫描）。
尽量使用range及以下的方式进行查询</p></li></ol> <h3 id="索引下推"><a href="#索引下推" class="header-anchor">#</a> 索引下推</h3> <p>联合索引遍历过程中，对联合索引中包含的字段先做判断，直接过滤掉不满足条件的记录，减少回表次数。</p> <h3 id="回表"><a href="#回表" class="header-anchor">#</a> 回表</h3> <p>二级索引查询到主键后去主键索引查询数据</p> <h3 id="覆盖索引"><a href="#覆盖索引" class="header-anchor">#</a> 覆盖索引</h3> <p>二级索引查询到的值包含需要查询的值</p> <h3 id="索引失效"><a href="#索引失效" class="header-anchor">#</a> 索引失效</h3> <ol><li><p>使用左或者左右模糊查询
索引都是根据字段进行前缀匹配，模糊查询无法进行匹配定位到索引位置，只能采用全表扫描的办法
这种方法也不一定会失效，只有两个字段，一个主键索引，一个二级索引，查询的时候就直接查询二级索引，因为二级索引就包含了全部的字段数据（id）,索引覆盖。</p></li> <li><p>采用函数
索引B+树结构中都是存储的原始索引字段的数据，进行函数计算后自然无法进行匹配；不过mysql8.0新出了函数索引，允许对字段数值进行函数操作后的值作为索引建立B+树</p></li> <li><p>采用表达式
a+1=10,这种写法和采用函数差不多；a=10-1这种写法会进行优化，送给存储引擎的就是a=9，会走索引</p></li> <li><p>联合索引不符合最左匹配原则
联合索引是按照第一个索引字段进行排序，只有第一个相同才会看第二个字段，以此类推。可以这样理解，联合索引就像是一个二级索引，这个二级索引是不同字段顺序拼接组成的，不符合最左匹配原则就相当于使用了左模糊查询。肯定是会失效的啊</p></li> <li><p>where or前面使用索引，后面没有使用索引
where or是条件查询，只要满足一个就能查询。</p></li> <li><p>字段隐式转换
字段是字符串，查询使用整型会全表扫描；但是反过来索引生效
因为MySQL在字符串和数字进行比较的时候会将字符串转化为数字进行比较。相当于进行了函数调用</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_user <span class="token keyword">where</span> CAST<span class="token punctuation">(</span>phone <span class="token keyword">AS</span> signed <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1300000001</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_user <span class="token keyword">where</span> id <span class="token operator">=</span> CAST<span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span> <span class="token keyword">AS</span> signed <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ol> <p>索引不一定就是能够排除一些数据快，有可能用了索引但是也是全局扫描了一边索引，即使这样索引也是比全表扫描要快的，因为索引数据更集中，查询字段较少，链表连接，需要的磁盘IO一般也较少。主要还是IO成本较低</p> <h3 id="count操作"><a href="#count操作" class="header-anchor">#</a> Count操作</h3> <p>count()是一个==聚合函数==，可以统计符合条件的数据条数。
MySQL的server层会维护一个count变量，统计到符合数据就会＋1，最后将结果返回给客户端</p> <h4 id="count-主键-条件"><a href="#count-主键-条件" class="header-anchor">#</a> Count（主键|条件）</h4> <p>如果没有二级索引，直接循环遍历索引B+树；当有二级索引时会遍历二级索引，如果符合条件就＋1</p> <h4 id="count-1"><a href="#count-1" class="header-anchor">#</a> Count（1）</h4> <p>如果没有二级索引，直接循环遍历索引B+树；当有二级索引时会遍历二级索引，如果有多个二级索引就遍历key_len最短的哪一个，查到记录就＋1，注意不会去查询字段</p> <h4 id="count"><a href="#count" class="header-anchor">#</a> Count（*）</h4> <p>count（*）执行时会被优化成count（0），执行流程和count（1）一样</p> <h4 id="count-字段"><a href="#count-字段" class="header-anchor">#</a> Count（字段）</h4> <p>遍历数据字段</p> <p>count（1）=count(*)&gt;count(索引字段)&gt;count（字段）</p> <p>大表count（*）语句执行较慢，可以使用explain进行估计，也可以维护一张计数表</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token keyword">table</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><img src="/assets/img/47b2ede574bc91b4262ab28a492944e3.47b2ede5.png" alt="img"> <h2 id="mysql事务"><a href="#mysql事务" class="header-anchor">#</a> MySQL事务</h2> <h3 id="事物的特性"><a href="#事物的特性" class="header-anchor">#</a> 事物的特性</h3> <p>A: Automicity   原子性，一个事务的操作要么成功，要么失败---》undo log回滚日志保证
C: Consistency  一致性，事务操作前后，数据满足完整性约束---》AID来保证
I: Isolation    隔离性，多个并发事务之间的数据空间是隔离的---》mvcc或锁机制
D: Durability   持久性，事务结束后对数据的修改是永久的---》redo log重做日志保证</p> <h3 id="并行事务"><a href="#并行事务" class="header-anchor">#</a> 并行事务</h3> <p>处理多个事务的时候会出现脏读，幻读，不可重复读的问题</p> <h4 id="脏读"><a href="#脏读" class="header-anchor">#</a> 脏读</h4> <p>一个事务读取到了另一个未提交的事务修改过的数据。</p> <h4 id="不可重复读"><a href="#不可重复读" class="header-anchor">#</a> 不可重复读</h4> <p>一个事务内多次查询同一个数据，所得到的数据不一样</p> <h4 id="幻读"><a href="#幻读" class="header-anchor">#</a> 幻读</h4> <p>在一个事务内多次查询某个符合条件的记录数量，前后查询的得到的数量不一致</p> <h3 id="事务的隔离级别"><a href="#事务的隔离级别" class="header-anchor">#</a> 事务的隔离级别</h3> <p>读未提交：一个事务所做的变更在它未提交的时候可以被其他事务看到（脏读、幻读、不可重复读）直接读取最新数据</p> <p>读已提交：一个事务所做的变更在他提交之后才能被其他事务看到（幻读、不可重复读） ReadView每个语句执行前生成</p> <p>可重复读：一个事务执行过程中看到的数据和启动时看到的数据一致（幻读）默认的隔离级别 ReadView开启事务前生成</p> <p>串行化：在多个事务对这条记录进行读写操作时，后访问的事务必须等前一个事务执行完成，才能继续执行（null） 读写锁</p> <h2 id="mvcc"><a href="#mvcc" class="header-anchor">#</a> MVCC</h2> <h3 id="readview在mvcc如何工作"><a href="#readview在mvcc如何工作" class="header-anchor">#</a> ReadView在MVCC如何工作</h3> <p>ReadView四个字段</p> <img src="/assets/img/11.f0d23f53.png" alt="img"> <p>聚簇索引记录中的两个隐藏列：</p> <img src="/assets/img/f595d13450878acd04affa82731f76c5.e633923c.png" alt="图片"> <ul><li>trx_id: 修改行记录的事务id</li> <li>roll_pointer:指向undo log里面旧版本的行记录</li></ul> <p>创建ReadView后，可以将事务分为三类：</p> <img src="/assets/img/ReadView.drawio.d411f51f.png" alt="img"> <p>一个事务去访问记录的时候，除了自己的更新记录总是可见之外，还有这几种情况：</p> <ul><li>如果记录的 trx_id 值小于 Read View 中的 <code>min_trx_id</code> 值，表示这个版本的记录是在创建 Read View <strong>前</strong>已经提交的事务生成的，所以该版本的记录对当前事务<strong>可见</strong>。</li> <li>如果记录的 trx_id 值大于等于 Read View 中的 <code>max_trx_id</code> 值，表示这个版本的记录是在创建 Read View <strong>后</strong>才启动的事务生成的，所以该版本的记录对当前事务<strong>不可见</strong>。</li> <li>如果记录的 trx_id 值在 Read View 的min_trx_id和max_trx_id之间，需要判断 trx_id 是否在 m_ids 列表中：
<ul><li>如果记录的 trx_id <strong>在</strong> <code>m_ids</code> 列表中，表示生成该版本记录的活跃事务依然活跃着（还没提交事务），所以该版本的记录对当前事务<strong>不可见</strong>。</li> <li>如果记录的 trx_id <strong>不在</strong> <code>m_ids</code>列表中，表示生成该版本记录的活跃事务已经被提交，所以该版本的记录对当前事务<strong>可见</strong>。</li></ul></li></ul> <p><strong>这种通过「版本链」来控制并发事务访问同一个记录时的行为就叫 MVCC（多版本并发控制）。</strong></p> <h3 id="可重复读控制流程"><a href="#可重复读控制流程" class="header-anchor">#</a> 可重复读控制流程</h3> <p>可重复读是在事务启动时生成的一个ReadView，整个事务期间数据都用这个ReadView</p> <img src="/assets/img/ab.12c315cc.png" alt="img"> <ul><li>事务 B 读取小林的账户余额记录，读到余额是 100 万；</li> <li>事务 A 将小林的账户余额记录修改成 200 万，并没有提交事务；</li> <li>事务 B 读取小林的账户余额记录，读到余额还是 100 万；</li> <li>事务 A 提交事务；</li> <li>事务 B 读取小林的账户余额记录，读到余额依然还是 100 万；</li></ul> <p>事务 B 第一次读小林的账户余额记录，在找到记录后，它会先看这条记录的 trx_id，此时<strong>发现 trx_id 为 50，比事务 B 的 Read View 中的 min_trx_id 值（51）还小，这意味着修改这条记录的事务早就在事务 B 启动前提交过了，所以该版本的记录对事务 B 可见的</strong>，也就是事务 B 可以获取到这条记录。</p> <p>接着，事务 A 通过 update 语句将这条记录修改了（还未提交事务），将小林的余额改成 200 万，这时 MySQL 会记录相应的 undo log，并以链表的方式串联起来，形成<strong>版本链</strong>，如下图：</p> <img src="/assets/img/12.b032b69e.png" alt="img"> <p>你可以在上图的「记录的字段」看到，由于事务 A 修改了该记录，以前的记录就变成旧版本记录了，于是最新记录和旧版本记录通过链表的方式串起来，而且最新记录的 trx_id 是事务 A 的事务 id（trx_id = 51）。</p> <p>然后事务 B 第二次去读取该记录，<strong>发现这条记录的 trx_id 值为 51，在事务 B 的 Read View 的 min_trx_id 和 max_trx_id 之间，则需要判断 trx_id 值是否在 m_ids 范围内，判断的结果是在的，那么说明这条记录是被还未提交的事务修改的，这时事务 B 并不会读取这个版本的记录。而是沿着 undo log 链条往下找旧版本的记录，直到找到 trx_id 「小于」事务 B 的 Read View 中的 min_trx_id 值的第一条记录</strong>，所以事务 B 能读取到的是 trx_id 为 50 的记录，也就是小林余额是 100 万的这条记录。</p> <p>最后，当事物 A 提交事务后，<strong>由于隔离级别时「可重复读」，所以事务 B 再次读取记录时，还是基于启动事务时创建的 Read View 来判断当前版本的记录是否可见。所以，即使事物 A 将小林余额修改为 200 万并提交了事务， 事务 B 第三次读取记录时，读到的记录都是小林余额是 100 万的这条记录</strong>。</p> <p>就是通过这样的方式实现了，「可重复读」隔离级别下在事务期间读到的记录都是事务启动前的记录。</p> <h3 id="读提交控制流程"><a href="#读提交控制流程" class="header-anchor">#</a> 读提交控制流程</h3> <p>读提交就是在每条语句执行前生成ReadView</p> <img src="/assets/img/25.12c315cc.png" alt="img"> <ul><li>事务 B 读取数据（创建 Read View），小林的账户余额为 100 万；</li> <li>事务 A 修改数据（还没提交事务），将小林的账户余额从 100 万修改成了 200 万；</li> <li>事务 B 读取数据（创建 Read View），小林的账户余额为 100 万；</li> <li>事务 A 提交事务；</li> <li>事务 B 读取数据（创建 Read View），小林的账户余额为 200 万；</li></ul> <p>前两次 事务 B 读取数据时创建的 Read View 如下图：</p> <img src="/assets/img/13.b0d96172.png" alt="img"> <p>我们来分析下为什么事务 B 第二次读数据时，读不到事务 A （还未提交事务）修改的数据？</p> <p>事务 B 在找到小林这条记录时，会看这条记录的 trx_id 是 51，在事务 B 的 Read View 的 min_trx_id 和 max_trx_id 之间，接下来需要判断 trx_id 值是否在 m_ids 范围内，判断的结果是在的，那么说明<strong>这条记录是被还未提交的事务修改的，这时事务 B 并不会读取这个版本的记录</strong>。而是，沿着 undo log 链条往下找旧版本的记录，直到找到 trx_id 「小于」事务 B 的 Read View 中的 min_trx_id 值的第一条记录，所以事务 B 能读取到的是 trx_id 为 50 的记录，也就是小林余额是 100 万的这条记录。</p> <p>我们来分析下为什么事务 A 提交后，事务 B 就可以读到事务 A 修改的数据？</p> <p>在事务 A 提交后，<strong>由于隔离级别是「读提交」，所以事务 B 在每次读数据的时候，会重新创建 Read View</strong>，此时事务 B 第三次读取数据时创建的 Read View 如下：</p> <img src="/assets/img/14.09ee6493.png" alt="img"> <p>事务 B 在找到小林这条记录时，<strong>会发现这条记录的 trx_id 是 51，比事务 B 的 Read View 中的 min_trx_id 值（52）还小，这意味着修改这条记录的事务早就在创建 Read View 前提交过了，所以该版本的记录对事务 B 是可见的</strong>。</p> <p>正是因为在读提交隔离级别下，事务每次读数据时都重新创建 Read View，那么在事务期间的多次读取同一条数据，前后两次读的数据可能会出现不一致，因为可能这期间另外一个事务修改了该记录，并提交了事务。</p> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <p>InnoDB 引擎的默认隔离级别虽然是「可重复读」，但是它很大程度上避免幻读现象（并不是完全解决了），解决的方案有两种：</p> <ul><li>针对<strong>快照读</strong>（普通 select 语句），是<strong>通过 MVCC 方式解决了幻读</strong>，因为可重复读隔离级别下，事务执行过程中看到的数据，一直跟这个事务启动时看到的数据是一致的，即使中途有其他事务插入了一条数据，是查询不出来这条数据的，所以就很好了避免幻读问题。</li> <li>针对<strong>当前读</strong>（select ... for update 等语句），是<strong>通过 next-key lock（记录锁+间隙锁）方式解决了幻读</strong>，因为当执行 select ... for update 语句的时候，会加上 next-key lock，如果有其他事务在 next-key lock 锁范围内插入了一条记录，那么这个插入语句就会被阻塞，无法成功插入，所以就很好了避免幻读问题。</li></ul> <h2 id="mysql锁事"><a href="#mysql锁事" class="header-anchor">#</a> MySQL锁事</h2> <h3 id="mysql有哪些锁"><a href="#mysql有哪些锁" class="header-anchor">#</a> MySQL有哪些锁</h3> <p>MySQL中根据加锁的范围可以分为三种：</p> <ol><li>全局锁
FTWRL</li> <li>表级锁
表锁
元数据锁
意向锁
AUTO——INC锁</li> <li>行级锁
Record Lock
GapLock
NextKey Lock</li></ol> <h4 id="全局锁"><a href="#全局锁" class="header-anchor">#</a> 全局锁</h4> <p>执行下面的命令，整个数据库就处于只读状态</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">//加锁</span>
flush <span class="token keyword">tables</span> <span class="token keyword">with</span> <span class="token keyword">read</span> <span class="token keyword">lock</span>
<span class="token comment">//解锁或者断开会话</span>
<span class="token keyword">unlock</span> <span class="token keyword">tables</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>全局锁主要用于数据库备份阶段，数据都是只读的状态，不会出现数据不一致，但是会影响业务正常进行</p> <p>如果数据库的引擎支持的事务支持<strong>可重复读的隔离级别</strong>，那么在备份数据库之前先开启事务，会先创建 Read View，然后整个事务执行期间都在用这个 Read View，而且由于 MVCC 的支持，备份期间业务依然可以对数据进行更新操作。</p> <p>备份数据库的工具是 mysqldump，在使用 mysqldump 时加上 <code>–single-transaction</code> 参数的时候，就会在备份数据库之前先开启事务</p> <h4 id="表级锁"><a href="#表级锁" class="header-anchor">#</a> 表级锁</h4> <p>MYSQL表级锁有：</p> <ol><li>表锁</li> <li>元数据锁</li> <li>意向锁</li> <li>AUTO-INC锁</li></ol> <p>表锁</p> <p>对某一个表进行加锁</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">//表级别的共享锁，也就是读锁；</span>
<span class="token keyword">lock</span> <span class="token keyword">tables</span> t_student <span class="token keyword">read</span><span class="token punctuation">;</span>

<span class="token comment">//表级别的独占锁，也就是写锁；</span>
<span class="token keyword">lock</span> <span class="token keyword">tables</span> t_stuent <span class="token keyword">write</span><span class="token punctuation">;</span>
<span class="token comment">//解锁或者结束会话</span>
<span class="token keyword">unlock</span> <span class="token keyword">tables</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>加的锁对于加锁线程也是生效的，加共享锁那么不仅是其他线程，包括加锁线程执行写操作都是会被阻塞的</p> <h5 id="元数据锁"><a href="#元数据锁" class="header-anchor">#</a> 元数据锁</h5> <p>当我们进行数据库表操作时，数据库会自动加上这个锁</p> <ul><li>对一张表进行CRUD操作加的是MDL读锁</li> <li>对一张表结构做变更加的是MDL写锁</li></ul> <p>MDL 是为了保证当用户对表执行 CRUD 操作时，防止其他线程对这个表结构做了变更。</p> <p>MDL 是在事务提交后才会释放，这意味着<strong>事务执行期间，MDL 是一直持有的</strong>。</p> <p>因此当一个长事务后面一个线程修改表结构会因为迟迟得不到MDL锁而导致后续读操作阻塞，（申请锁的队列中写锁获取优先级高于读锁）</p> <p>可以先kill这个长事务，然后在做表结构的变更</p> <h5 id="意向锁"><a href="#意向锁" class="header-anchor">#</a> 意向锁</h5> <ul><li>在使用 InnoDB 引擎的表里对某些==行==记录加上「共享锁」之前，需要先在==表==级别加上一个「意向共享锁」；</li> <li>在使用 InnoDB 引擎的表里对某些==行==记录加上「独占锁」之前，需要先在==表==级别加上一个「意向独占锁」；</li></ul> <p>也就是，当执行插入、更新、删除操作，需要先对表加上「意向独占锁」，然后对该记录加独占锁。</p> <p>而普通的 select 是不会加行级锁的，普通的 select 语句是利用 MVCC 实现一致性读，是无锁的。</p> <p>不过，select 也是可以对记录加共享锁和独占锁的，具体方式如下：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">//先在表上加上意向共享锁，然后对读取的记录加共享锁</span>
<span class="token keyword">select</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">lock</span> <span class="token operator">in</span> <span class="token keyword">share</span> <span class="token keyword">mode</span><span class="token punctuation">;</span>

<span class="token comment">//先表上加上意向独占锁，然后对读取的记录加独占锁</span>
<span class="token keyword">select</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>==意向共享锁和意向独占锁是表级锁==，不会和行级的共享锁和独占锁发生冲突，而且意向锁之间也不会发生冲突，只会和共享表锁（lock tables ... read）和独占表锁（lock tables ... write）发生冲突。</p> <p>表锁和行锁是满足读读共享、读写互斥、写写互斥的。</p> <p>如果没有「意向锁」，那么加「独占表锁」时，就需要遍历表里所有记录，查看是否有记录存在独占锁，这样效率会很慢。</p> <p>那么有了「意向锁」，由于在对记录加独占锁前，先会加上表级别的意向独占锁，那么在加「独占表锁」时，直接查该表是否有意向独占锁，如果有就意味着表里已经有记录被加了独占锁，这样就不用去遍历表里的记录。</p> <p>所以，<strong>意向锁的目的是为了快速判断表里是否有记录被加锁</strong>。</p> <h5 id="auto-inc锁"><a href="#auto-inc锁" class="header-anchor">#</a> AUTO-INC锁</h5> <p>表里的主键通常都会设置成自增的，这是通过对主键字段声明 <code>AUTO_INCREMENT</code> 属性实现的。</p> <p>之后可以在插入数据时，可以不指定主键的值，数据库会自动给主键赋值递增的值，这主要是通过 <strong>AUTO-INC 锁</strong>实现的。</p> <p>AUTO-INC 锁是特殊的表锁机制，锁<strong>不是再一个事务提交后才释放，而是再执行完插入语句后就会立即释放</strong>。</p> <p><strong>在插入数据时，会加一个表级别的 AUTO-INC 锁</strong>，然后为被 <code>AUTO_INCREMENT</code> 修饰的字段赋值递增的值，等插入语句执行完成后，才会把 AUTO-INC 锁释放掉。</p> <p>那么，一个事务在持有 AUTO-INC 锁的过程中，其他事务的如果要向该表插入语句都会被阻塞，从而保证插入数据时，被 <code>AUTO_INCREMENT</code> 修饰的字段的值是连续递增的。</p> <p>但是， AUTO-INC 锁再对大量数据进行插入的时候，会影响插入性能，因为另一个事务中的插入会被阻塞。</p> <p>因此， 在 MySQL 5.1.22 版本开始，InnoDB 存储引擎提供了一种<strong>轻量级的锁</strong>来实现自增。</p> <p>一样也是在插入数据的时候，会为被 <code>AUTO_INCREMENT</code> 修饰的字段加上轻量级锁，<strong>然后给该字段赋值一个自增的值，就把这个轻量级锁释放了，而不需要等待整个插入语句执行完后才释放锁</strong>。</p> <p>InnoDB 存储引擎提供了个 innodb_autoinc_lock_mode 的系统变量，是用来控制选择用 AUTO-INC 锁，还是轻量级的锁。</p> <ul><li>当 innodb_autoinc_lock_mode = 0，就采用 AUTO-INC 锁，语句执行结束后才释放锁；</li> <li>当 innodb_autoinc_lock_mode = 2，就采用轻量级锁，申请自增主键后就释放锁，并不需要等语句执行后才释放。</li> <li>当 innodb_autoinc_lock_mode = 1：
<ul><li>普通 insert 语句，自增锁在申请之后就马上释放；</li> <li>类似 insert … select 这样的批量插入数据的语句，自增锁还是要等语句结束后才被释放；</li></ul></li></ul> <p>当 innodb_autoinc_lock_mode = 2 是性能最高的方式，但是当搭配 binlog 的日志格式是 statement 一起使用的时候，在「主从复制的场景」中会发生<strong>数据不一致的问题</strong>。</p> <p>举个例子，考虑下面场景：</p> <img src="/assets/img/innodb_autoinc_lock_mode=2.fbc23773.png" alt="img" style="zoom:80%;"> <p>session A 往表 t 中插入了 4 行数据，然后创建了一个相同结构的表 t2，然后<strong>两个 session 同时执行向表 t2 中插入数据</strong>。</p> <p>如果 innodb_autoinc_lock_mode = 2，意味着「申请自增主键后就释放锁，不必等插入语句执行完」。那么就可能出现这样的情况：</p> <ul><li>session B 先插入了两个记录，(1,1,1)、(2,2,2)；</li> <li>然后，session A 来申请自增 id 得到 id=3，插入了（3,5,5)；</li> <li>之后，session B 继续执行，插入两条记录 (4,3,3)、 (5,4,4)。</li></ul> <p>可以看到，<strong>session B 的 insert 语句，生成的 id 不连续</strong>。</p> <p>当「主库」发生了这种情况，binlog 面对 t2 表的更新只会记录这两个 session 的 insert 语句，如果 binlog_format=statement，记录的语句就是原始语句。记录的顺序要么先记 session A 的 insert 语句，要么先记 session B 的 insert 语句。</p> <p>但不论是哪一种，这个 binlog 拿去「从库」执行，这时从库是按「顺序」执行语句的，只有当执行完一条 SQL 语句后，才会执行下一条 SQL。因此，在<strong>从库上「不会」发生像主库那样两个 session 「同时」执行向表 t2 中插入数据的场景。所以，在备库上执行了 session B 的 insert 语句，生成的结果里面，id 都是连续的。这时，主从库就发生了数据不一致</strong>。</p> <p>要解决这问题，binlog 日志格式要设置为 row，这样在 binlog 里面记录的是主库分配的自增值，到备库执行的时候，主库的自增值是什么，从库的自增值就是什么。</p> <p>所以，<strong>当 innodb_autoinc_lock_mode = 2 时，并且 binlog_format = row，既能提升并发性，又不会出现数据一致性问题</strong>。</p> <h4 id="行级锁"><a href="#行级锁" class="header-anchor">#</a> 行级锁</h4> <p>普通的 select 语句是不会对记录加锁的，因为它属于快照读。如果要在查询时对记录加行锁，可以使用下面这两个方式，这种查询会加锁的语句称为<strong>锁定读</strong>。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">//对读取的记录加共享锁</span>
<span class="token keyword">select</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">lock</span> <span class="token operator">in</span> <span class="token keyword">share</span> <span class="token keyword">mode</span><span class="token punctuation">;</span>

<span class="token comment">//对读取的记录加独占锁</span>
<span class="token keyword">select</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>上面这两条语句必须在一个事务中，<strong>因为当事务提交了，锁就会被释放</strong>，所以在使用这两条语句的时候，要加上 begin、start transaction 或者 set autocommit = 0。</p> <p>共享锁（S锁）满足读读共享，读写互斥。独占锁（X锁）满足写写互斥、读写互斥。</p> <p>行级锁的类型主要有三类：</p> <ul><li>Record Lock，记录锁，也就是仅仅把一条记录锁上；</li> <li>Gap Lock，间隙锁，锁定一个范围，但是不包含记录本身；</li> <li>Next-Key Lock：Record Lock + Gap Lock 的组合，锁定一个范围，并且锁定记录本身。</li></ul> <h5 id="record-lock"><a href="#record-lock" class="header-anchor">#</a> Record Lock</h5> <p>Record Lock 称为记录锁，锁住的是一条记录。而且记录锁是有 S 锁和 X 锁之分的：</p> <ul><li>当一个事务对一条记录加了 S 型记录锁后，其他事务也可以继续对该记录加 S 型记录锁（S 型与 S 锁兼容），但是不可以对该记录加 X 型记录锁（S 型与 X 锁不兼容）;</li> <li>当一个事务对一条记录加了 X 型记录锁后，其他事务既不可以对该记录加 S 型记录锁（S 型与 X 锁不兼容），也不可以对该记录加 X 型记录锁（X 型与 X 锁不兼容）。</li></ul> <p>当事务执行 commit 后，事务过程中生成的锁都会被释放</p> <h5 id="gap-lock"><a href="#gap-lock" class="header-anchor">#</a> Gap Lock</h5> <p>Gap Lock 称为间隙锁，只存在于可重复读隔离级别，目的是为了解决可重复读隔离级别下幻读的现象。</p> <p>假设，表中有一个范围 id 为（3，5）间隙锁，那么其他事务就无法插入 id = 4 这条记录了，这样就有效的防止幻读现象的发生。</p> <img src="/assets/img/15.ec144065.png" alt="img"> <p>间隙锁虽然存在 X 型间隙锁和 S 型间隙锁，但是并没有什么区别，<strong>间隙锁之间是兼容的，即两个事务可以同时持有包含共同间隙范围的间隙锁，并不存在互斥关系，因为间隙锁的目的是防止插入幻影记录而提出的</strong></p> <h5 id="next-key-lock"><a href="#next-key-lock" class="header-anchor">#</a> Next-Key Lock</h5> <p>Next-Key Lock 称为临键锁，是 Record Lock + Gap Lock 的组合，锁定一个范围，并且锁定记录本身。</p> <p>假设，表中有一个范围 id 为（3，5] 的 next-key lock，那么其他事务即不能插入 id = 4 记录，也不能修改 id = 5 这条记录。</p> <img src="/assets/img/16.dc6d8d8e.png" alt="img"> <p>所以，next-key lock 即能保护该记录，又能阻止其他事务将新纪录插入到被保护记录前面的间隙中。</p> <p><strong>next-key lock 是包含间隙锁+记录锁的，如果一个事务获取了 X 型的 next-key lock，那么另外一个事务在获取相同范围的 X 型的 next-key lock 时，是会被阻塞的</strong>。</p> <p>比如，一个事务持有了范围为 (1, 10] 的 X 型的 next-key lock，那么另外一个事务在获取相同范围的 X 型的 next-key lock 时，就会被阻塞。</p> <p>虽然相同范围的间隙锁是多个事务相互兼容的，但对于记录锁，我们是要考虑 X 型与 S 型关系，X 型的记录锁与 X 型的记录锁是冲突的。</p> <h5 id="插入意向锁"><a href="#插入意向锁" class="header-anchor">#</a> 插入意向锁</h5> <p>一个事务在插入一条记录的时候，需要判断插入位置是否已被其他事务加了间隙锁（next-key lock 也包含间隙锁）。</p> <p>如果有的话，插入操作就会发生<strong>阻塞</strong>，直到拥有间隙锁的那个事务提交为止（释放间隙锁的时刻），在此期间会生成一个<strong>插入意向锁</strong>，表明有事务想在某个区间插入新记录，但是现在处于等待状态。</p> <p>举个例子，假设事务 A 已经对表加了一个范围 id 为（3，5）间隙锁。</p> <img src="/assets/img/17.ec144065.png" alt="img"> <p>当事务 A 还没提交的时候，事务 B 向该表插入一条 id = 4 的新记录，这时会判断到插入的位置已经被事务 A 加了间隙锁，于是事物 B 会生成一个插入意向锁，然后将锁的状态设置为等待状态（<em>PS：MySQL 加锁时，是先生成锁结构，然后设置锁的状态，如果锁状态是等待状态，并不是意味着事务成功获取到了锁，只有当锁状态为正常状态时，才代表事务成功获取到了锁</em>），此时事务 B 就会发生阻塞，直到事务 A 提交了事务。</p> <p>插入意向锁名字虽然有意向锁，但是它并<strong>不是意向锁，它是一种特殊的间隙锁，属于行级别锁</strong>。</p> <p>如果说间隙锁锁住的是一个区间，那么「插入意向锁」锁住的就是一个点。因而从这个角度来说，插入意向锁确实是一种特殊的间隙锁。</p> <p>插入意向锁与间隙锁的另一个非常重要的差别是：尽管「插入意向锁」也属于间隙锁，但两个事务却不能在同一时间内，一个拥有间隙锁，另一个拥有该间隙区间内的插入意向锁（当然，插入意向锁如果不在间隙锁区间内则是可以的）。</p> <h3 id="mysql锁的特征"><a href="#mysql锁的特征" class="header-anchor">#</a> MySQL锁的特征</h3> <h4 id="行级锁-2"><a href="#行级锁-2" class="header-anchor">#</a> 行级锁</h4> <p>普通的select语句是不会加行级锁的（除了串行化），因为它属于快照读，是通过mvcc实现的</p> <p>如果要在查询时对记录加行级锁，可以使用下面这两个方式，这两种查询会加锁的语句称为<strong>锁定读</strong>。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">//对读取的记录加共享锁(S型锁)</span>
<span class="token keyword">select</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">lock</span> <span class="token operator">in</span> <span class="token keyword">share</span> <span class="token keyword">mode</span><span class="token punctuation">;</span>

<span class="token comment">//对读取的记录加独占锁(X型锁)</span>
<span class="token keyword">select</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>上面这两条语句必须在一个事务中，<strong>因为当事务提交了，锁就会被释放</strong>，所以在使用这两条语句的时候，要加上 begin 或者 start transaction 开启事务的语句。</p> <p><strong>pdate 和 delete 操作都会加行级锁，且锁的类型都是独占锁(X型锁)</strong>。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">//对操作的记录加独占锁(X型锁)</span>
<span class="token keyword">update</span> <span class="token keyword">table</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">//对操作的记录加独占锁(X型锁)</span>
<span class="token keyword">delete</span> <span class="token keyword">from</span> <span class="token keyword">table</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="record-lock-2"><a href="#record-lock-2" class="header-anchor">#</a> Record Lock</h4> <p>记录锁，记录的是一条行记录，有s和x之分</p> <ul><li>一个事务对一条记录添加s锁，其他事务可以添加s锁，不能添加x锁</li> <li>一个事务对一条记录添加x锁，其他事务s，x锁都不能添加</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql <span class="token operator">&gt;</span> <span class="token keyword">begin</span><span class="token punctuation">;</span>
mysql <span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_test <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>事务会对表中主键 id = 1 的这条记录加上 X 型的记录锁，如果这时候其他事务对这条记录进行删除或者更新操作，那么这些操作都会被阻塞。注意，其他事务插入一条 id = 1 的新记录并不会被阻塞，而是会报主键冲突的错误，这是因为主键有唯一性的约束。</p> <p>当事务执行 commit 后，事务过程中生成的锁都会被释放。</p> <p>Gap Lock</p> <p>间隙锁，只存在于可重复读隔离级别，解决幻读</p> <p>假设，表中有一个范围 id 为（3，5）间隙锁，那么其他事务就无法插入 id = 4 这条记录了，这样就有效的防止幻读现象的发生。</p> <p>间隙锁虽然存在 X 型间隙锁和 S 型间隙锁，但是并没有什么区别，<strong>间隙锁之间是兼容的，即两个事务可以同时持有包含共同间隙范围的间隙锁，并不存在互斥关系，因为间隙锁的目的是防止插入幻影记录而提出的</strong>。</p> <h4 id="next-key-lock-2"><a href="#next-key-lock-2" class="header-anchor">#</a> Next-Key Lock</h4> <p>临建锁，Record Lock+Gap Lock的组合，锁定一个范围包括行记录本身</p> <p>假设，表中有一个范围 id 为（3，5] 的 next-key lock，那么其他事务即不能插入 id = 4 记录，也不能修改和删除 id = 5 这条记录。</p> <p><strong>next-key lock 是包含间隙锁+记录锁的，如果一个事务获取了 X 型的 next-key lock，那么另外一个事务在获取相同范围的 X 型的 next-key lock 时，是会被阻塞的</strong>。这种特性是由记录锁决定的</p> <h3 id="mysql加锁时机"><a href="#mysql加锁时机" class="header-anchor">#</a> MySQL加锁时机</h3> <p>行级锁加锁的对象是索引，加锁的基本单位是next-key lock临键锁。</p> <h4 id="唯一索引等值查询"><a href="#唯一索引等值查询" class="header-anchor">#</a> 唯一索引等值查询</h4> <ul><li>当查询的记录是「存在」的，在索引树上定位到这一条记录后，该记录的索引中的 next-key lock 会<strong>退化成「记录锁」</strong>。</li> <li>当查询的记录是「不存在」的，在索引树找到第一条大于该查询记录的记录后，将该记录的索引中的 next-key lock 会<strong>退化成「间隙锁」</strong>。</li></ul> <h4 id="唯一索引范围查询"><a href="#唯一索引范围查询" class="header-anchor">#</a> 唯一索引范围查询</h4> <p>对查询到的每一个索引添加next-key lock</p> <ul><li><p>大于等于，那一条符合等于的索引会编程记录锁，其他的还是临键锁</p></li> <li><p>小于等于或者小于：</p> <p>当条件值不存在时：扫描到终止范围记录时，该记录的索引的next-key lock会退化成间隙锁，这个终止范围记录谁也查询不到，就是一个标志，自然没必要添加记录锁，
当条件值存在时：如果是小于，终止范围记录退化成间隙锁</p></li></ul> <p>大于：（n,+00] || （n-1,+00]</p> <p>大于等于就是 n + (n,+00]|| （n-1,+00]</p> <p>小于就是 （-00,n) || （-00,n+1）</p> <p>小于等于就是(-00,n]  || (-00,n+1)</p> <p>临键锁的区间范围只能是右边为闭区间（记录锁）</p> <p>我觉得这个临键锁有一定的要求，比如范围的右区间必须是闭区间即（n,n+1]，不满足的话比如【n,n+1)就退化成了一个记录锁n和一个间隙锁(n,n+1)，再比如(n,n+1)就退化成了一个间隙锁，翻译一下就是临键锁对应的记录它只会负责到前面区间（id小于自己）的那片间隔区域</p> <h4 id="非唯一索引等值查询"><a href="#非唯一索引等值查询" class="header-anchor">#</a> 非唯一索引等值查询</h4> <p>因为存在两个索引，一个主键索引，一个二级索引，在加锁的时候会同时对这两个索引加锁，但是对主键索引只有满足条件的记录才会加锁</p> <ul><li><p>cc</p></li> <li></li> <li><p>当查询二级索引存在的时候：非唯一索引等值查询的过程是一个扫描的过程，直到扫描到第一个不符合条件的二级索引记录就停止扫描，然后在扫描的过程中，对扫描到的二级索引记录加的是 next-key 锁，而对于第一个不符合条件的二级索引记录，该二级索引的 next-key 锁会退化成间隙锁。同时，在符合查询条件的记录的主键索引上加记录锁。</p></li> <li><p>当查询二级索引不存在的时候：扫描到第一条不符合条件的二级索引记录，该二级索引的 next-key 锁会退化成间隙锁。因为不存在满足查询条件的记录，所以不会对主键索引加锁。</p></li></ul> <h4 id="非唯一索引范围查询"><a href="#非唯一索引范围查询" class="header-anchor">#</a> 非唯一索引范围查询</h4> <p>非唯一索引进行范围查询时，对二级索引记录加锁都是加 next-key 锁。</p> <h4 id="没有索引的查询"><a href="#没有索引的查询" class="header-anchor">#</a> 没有索引的查询</h4> <p>如果锁定读查询语句，没有使用索引列作为查询条件，或者查询语句没有走索引查询，导致扫描是全表扫描。那么，每一条记录的索引上都会加 next-key 锁，这样就相当于锁住的全表，这时如果其他事务对该表进行增、删、改操作的时候，都会被阻塞。</p> <p>不只是锁定读查询语句不加索引才会导致这种情况，update 和 delete 语句如果查询条件不加索引，那么由于扫描的方式是全表扫描，于是就会对每一条记录的索引上都会加 next-key 锁，这样就相当于锁住的全表。</p> <h2 id="mysql日志"><a href="#mysql日志" class="header-anchor">#</a> MySQL日志</h2> <h3 id="undo-log"><a href="#undo-log" class="header-anchor">#</a> Undo Log</h3> <p>回滚日志，是InnoDB存储引擎生成的日志，实现了事务中的原子性，主要用于==事务回滚和MVCC==</p> <p>事务没有提交之前，MySQL会先记录增删改操作执行前的数据到undo log日志文件中，事务回滚时就会用到undo log</p> <ul><li>插入一条记录只需要记录主键内容，回滚的时候删除主键记录即可</li> <li>更新一条记录，把被更新的旧值（未更新的字段不记录）记录下来，回滚的时候使用旧值覆盖即可</li> <li>删除一条记录只需要把记录全都记录下来，当回滚时候插入该条记录即可</li></ul> <p>一条记录每次增删改操作产生的undo log格式都有一个roll_pointer指针和一个trx_id事务id</p> <h3 id="buffer-pool"><a href="#buffer-pool" class="header-anchor">#</a> Buffer Pool</h3> <p>InnoDB设计了一个缓冲池Buffer Pool，当修改记录后不是直接写回磁盘，而是先缓存起来，下次查询先从缓存中取。以此来提高数据库的读写性能。</p> <ul><li>读取数据时，先从缓存中查询，查询不到再去磁盘查找并更新缓存</li> <li>修改数据时，先去缓存中查找，直接修改患存中的数据，然后将该页标记为脏页，后续将脏页写入磁盘</li></ul> <p>Buffer Pool把申请到的内存分为若干个大小为16kb的缓存页，存储索引，数据，还有undo页，插入缓存，自适应hash索引，锁信息等。</p> <h3 id="redo-log"><a href="#redo-log" class="header-anchor">#</a> Redo Log</h3> <p>重做日志，是InnoDB存储引擎生成的日志，实现事务的持久性，主要用于掉电故障恢复，同时将写操作从随机写替换成了顺序写，提升了IO性能</p> <p>为了防止断电导致buffer pool缓存数据丢失的问题，当有一条记录更新的时候，InnoDB会先更新内存buffer pool数据页并标记为脏页，然后将对这个页的修改以redo log的形式记录下来，而且写入redo log的方式采用了追加的方式，是顺序写，比随机写高效。</p> <p>产生redo log记录时会先写到redo log buffer中，最后再异步持久化到磁盘中</p> <p>后续，InnoDB存储引擎会在适当时机启动后台线程将脏页持久化到磁盘中去，WAL（Write-Ahead Logging）技术。</p> <p>这样一来，MySQL重启时可以根据redo log日志将数据更新到最新状态</p> <img src="/assets/img/wal.b18e147b.png" alt="img"> <ul><li>redo log记录的时事务完成后的最新数据</li> <li>undo log记录的时事务开始前的最新数据</li></ul> <p>事务提交之前崩溃，数据可由undo log恢复
事务提交之后崩溃，数据可由redo log恢复</p> <h4 id="redo-log刷盘的时机"><a href="#redo-log刷盘的时机" class="header-anchor">#</a> redo log刷盘的时机</h4> <ul><li>MySQL服务正常关闭</li> <li>redo log buffer记录达到内存一半</li> <li>InnoDB后台线程每隔1s将redo log buffer持久到redo log文件</li> <li>每次事务提交，由<code>innodb_flush_log_at_trx_commit</code> 参数控制</li></ul> <ol><li>当设置该<strong>参数为 0 时</strong>，表示每次事务提交时 ，还是<strong>将 redo log 留在 redo log buffer 中</strong> ，该模式下在事务提交时不会主动触发写入磁盘的操作。（由每秒的后台线程控制写入磁盘）</li> <li>当设置该<strong>参数为 1 时</strong>，表示每次事务提交时，都<strong>将缓存在 redo log buffer 里的 redo log 直接持久化到磁盘</strong>，这样可以保证 MySQL 异常重启之后数据不会丢失。</li> <li>当设置该<strong>参数为 2 时</strong>，表示每次事务提交时，都只是缓存在 redo log buffer 里的 redo log <strong>写到 redo log 文件，注意写入到「 redo log 文件」并不意味着写入到了磁盘</strong>，因为操作系统的文件系统中有个 Page Cache，Page Cache 是专门用来缓存文件数据的，所以写入「 redo log文件」意味着写入到了操作系统的文件缓存。（由每秒的后台线程控制写入磁盘）</li></ol> <h4 id="redo-log写满了怎么办"><a href="#redo-log写满了怎么办" class="header-anchor">#</a> redo log写满了怎么办</h4> <p>InnoDB引擎有一个重做日志文件组，包含两个相同固定大小的redo log文件
redo log 是循环写的方式，相当于一个环形，InnoDB 用 write pos 表示 redo log 当前记录写到的位置，用 checkpoint 表示当前要擦除的位置，</p> <img src="/assets/img/checkpoint.a6b0d249.png" alt="img" style="zoom:80%;"> <p>图中的：</p> <ul><li>write pos 和 checkpoint 的移动都是顺时针方向；</li> <li>write pos ～ checkpoint 之间的部分（图中的红色部分），用来记录新的更新操作；</li> <li>check point ～ write pos 之间的部分（图中蓝色部分）：待落盘的脏数据页记录；</li></ul> <p>如果 write pos 追上了 checkpoint，就意味着 <strong>redo log 文件满了，这时 MySQL 不能再执行新的更新操作，也就是说 MySQL 会被阻塞</strong>（<em>因此所以针对并发量大的系统，适当设置 redo log 的文件大小非常重要</em>），此时<strong>会停下来将 Buffer Pool 中的脏页刷新到磁盘中，然后标记 redo log 哪些记录可以被擦除，接着对旧的 redo log 记录进行擦除，等擦除完旧记录腾出了空间，checkpoint 就会往后移动（图中顺时针）</strong>，然后 MySQL 恢复正常运行，继续执行新的更新操作。</p> <p>所以，一次 checkpoint 的过程就是脏页刷新到磁盘中变成干净页，然后标记 redo log 哪些记录可以被覆盖的过程。</p> <h3 id="bin-log"><a href="#bin-log" class="header-anchor">#</a> Bin Log</h3> <p>归档日志，是Server层生成的日志，更新语句执行完成后，server层会生成一条binlog，待事务提交完成后统一写入Bin Log文件，主要用户数据备份和主从复制。</p> <p>bin Log记录增删改操作和表的结构操作，只能用于归档，没有故障恢复能力</p> <p>redo log和bin log的对比：</p> <ol><li>binLog是server层实现的，任何存储引擎都能使用
redoLog是InnoDB实现的，专有</li> <li>binLog是追加写，文件写满就新建文件，保存的是全量日志
redoLog是循环写，日志空间大小恒定，保存未持久到磁盘的脏页日志</li> <li>binLog用于备份恢复、主从复制
redoLog用于故障恢复</li> <li>BinLog由三种文件格式
redoLog是物理日志</li></ol> <h4 id="binlog三种文件格式"><a href="#binlog三种文件格式" class="header-anchor">#</a> BinLog三种文件格式</h4> <p>STATEMENT：默认格式，每一条修改数据的 SQL 都会被记录到 binlog 中（相当于记录了逻辑操作，所以针对这种格式， binlog 可以称为逻辑日志），主从复制中 slave 端再根据 SQL 语句重现。但 STATEMENT 有动态函数的问题，比如你用了 uuid 或者 now 这些函数，你在主库上执行的结果并不是你在从库执行的结果，这种随时在变的函数会导致复制的数据不一致；（AUTO_INC采用轻量锁方案会出现id不一致问题）</p> <p>ROW：记录行数据最终修改后的数据，不会出现 STATEMENT 下动态函数的问题。但 ROW 的缺点是每行数据的变化结果都会被记录，比如执行批量 update 语句，更新多少行数据就会产生多少条记录，使 binlog 文件过大，而在 STATEMENT 格式下只会记录一个 update 语句而已；</p> <p>MIXED：包含了 STATEMENT 和 ROW 模式，它会根据不同的情况自动使用 ROW 模式和 STATEMENT 模式；</p> <h4 id="binlog刷盘时机"><a href="#binlog刷盘时机" class="header-anchor">#</a> BinLog刷盘时机</h4> <p>事务执行过程中生成的binlog会先存入该线程自己的binLog cacahe，事务提交完成后，再从cache写入binlog文件，并清空cache</p> <img src="/assets/img/binlogcache.drawio.56a73856.png" alt="binlog cach"> <p>MySQL提供一个 sync_binlog 参数来控制数据库的 binlog 刷到磁盘上的频率：</p> <ul><li>sync_binlog = 0 的时候，表示每次提交事务都只 write，不 fsync，后续交由操作系统决定何时将数据持久化到磁盘；（默认策略）</li> <li>sync_binlog = 1 的时候，表示每次提交事务都会 write，然后马上执行 fsync；</li> <li>sync_binlog =N(N&gt;1) 的时候，表示每次提交事务都 write，但累积 N 个事务后才 fsync。</li></ul> <h3 id="两阶段提交"><a href="#两阶段提交" class="header-anchor">#</a> 两阶段提交</h3> <p>事务提交后，redo log和bin log都需要持久化到磁盘，是两个独立的操作，非原子性的，可能出现数据不一致的问题</p> <ul><li>redo log刷盘成功，宕机，bin log刷盘失败，重启恢复时，主机根据redo log恢复数据，从机接受主机bin log数据恢复，修改的那条数据一新一旧不一致</li> <li>bin log刷盘成功，宕机，redo log刷盘失败，重启恢复时，主机根据redo log恢复数据，从机接受主机bin log数据恢复，修改的那条数据一旧一新不一致</li></ul> <p>因此出现半成功的状态时，redo log影响的是主机，bin log影响的是从机</p> <p>MySQL为了避免两份日志之间的逻辑不一致的问题，使用两阶段提交来解决，这是一种分布式事务一致性协议，可以保证多个操作逻辑原子性。</p> <p>两阶段提交把单个事务的提交分为了两个阶段，准备阶段和提交阶段。当客户端执行commit语句或者自动提交事务的情况下，MySQL会开启一个内部事务，分两阶段完成这个内部事务的提交</p> <img src="/assets/img/18.362acd82.png" alt="两阶段提交"> <ul><li></li> <li><p>准备阶段redo log刷盘持久化到磁盘</p></li> <li><p>提交阶段bin log刷盘，然后将该事务redo log状态设置为commit</p></li></ul> <p>当发生宕机或者重启时，主机对于redo log日志，会先查看状态是否是coomit，如果是说明同一事物的redo log和bin log都刷盘成功，直接恢复数据；如果不存在则获取该内部事务id，然后去bin log日志寻找是否存在该id的binLog，存在的话也认为事务提交成功，直接恢复数据；如果不存在则该redo log对应的事务不生效，回滚事务。</p> <p>总的来说，两阶段提交是看bin log是否提交成功决定的，这样设计主要是保证主库跟从库数据一致性，主库向从库看起的，自己数据旧，就将自己数据更新，自己数据新，就将自己数据回滚。</p> <h4 id="两阶段提交问题"><a href="#两阶段提交问题" class="header-anchor">#</a> 两阶段提交问题</h4> <ul><li>磁盘IO次数高
每个事务提交都需要将redo log和bin log进行刷盘</li> <li>锁竞争激烈
多事务情况下需要加锁保证单事务的两条刷盘操作连续执行</li></ul> <h4 id="优化方法"><a href="#优化方法" class="header-anchor">#</a> 优化方法</h4> <p>MySQL引入了组提交机制：当有多个事务提交的时候，会将多个binLog刷盘操作合并成为一个，从而减少磁盘IO次数。</p> <p>组提交后准备阶段不变，提交阶段分为三个过程</p> <ul><li>flush阶段：多个事务按顺序将binLog从cache写入文件</li> <li>sync阶段：对binLog文件做fsync操作</li> <li>commit阶段，各个事务按照顺序做InnoDB commit操作</li></ul> <p><strong>每个阶段都有一个队列</strong>，每个阶段有锁进行保护，因此保证了事务写入的顺序，第一个进入队列的事务会成为 leader，leader领导所在队列的所有事务，全权负责整队的操作，完成后通知队内其他事务操作结束。</p> <img src="/assets/img/commit_4.434a103a.png" alt="每个阶段都有一个队列"> <ul><li></li></ul> <p>锁粒度减小了，这样就可以多个阶段并发执行，从而提升效率。（这里原因可以类似理解为CPU的流水线工作方式）</p> <p>在 MySQL 5.7 版本中，做了个改进，在 prepare 阶段不再让事务各自执行 redo log 刷盘操作，而是推迟到组提交的 flush 阶段，也就是说 prepare 阶段融合在了 flush 阶段。</p> <p>这个优化是将 redo log 的刷盘延迟到了 flush 阶段之中，sync 阶段之前。通过延迟写 redo log 的方式，为 redolog 做了一次组写入，这样 binlog 和 redo log 都进行了优化。</p> <p>综上所述：当MySQL磁盘IO很高时</p> <ul><li>设置组提交的两个参数：binlog_group_commit_sync_delay和binlog_group_commit_sync_no_delay_count参数，延迟binlog刷盘的时机，从而减少刷盘次数</li> <li>将sync_binlog设置为大于1的值，表示每次提交事务都write，积累到n之后再fync</li> <li>将innodb_flush-log_at_trx_commit设置为2，表示每次事务提交时，都只是缓存再、将redo log buffer里面的redo log记录写到redo log文件（Page Cache），由系统控制刷盘时机</li></ul> <h2 id="bufferpool"><a href="#bufferpool" class="header-anchor">#</a> BufferPool</h2> <h3 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h3> <p>MySQL数据都是存储在磁盘中的，每次读取和存入都需要进行磁盘IO，非常耗时，因此InnoDB设计了一个缓冲池BufferPool，来提高==读写==性能</p> <ul><li>当读取数据时，如果数据存在于 Buffer Pool 中，客户端就会直接读取 Buffer Pool 中的数据，否则再去磁盘中读取，然后更新buffer pool里的数据页---》这是读性能</li> <li>当修改数据时，首先是修改 Buffer Pool 中数据所在的页，然后将其页设置为脏页，最后由后台线程将脏页写入到磁盘。-----》这是提升写性能</li></ul> <h3 id="结构组成"><a href="#结构组成" class="header-anchor">#</a> 结构组成</h3> <p>MySQL 启动的时候，InnoDB 会为 Buffer Pool 申请一片连续的内存空间，然后按照默认的<code>16KB</code>的大小划分出一个个的页， Buffer Pool 中的页就叫做缓存页</p> <p><img src="/assets/img/19.6bfa72fa.png" alt="img"></p> <p>InnoDB 为每一个缓存页都创建了一个<strong>控制块</strong>，控制块信息包括「缓存页的表空间、页号、缓存页地址、链表节点」等等。</p> <p>控制块也是占有内存空间的，它是放在 Buffer Pool 的最前面，接着才是缓存页，如下图：</p> <img src="data:image/png;base64,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" alt="img"> <h3 id="如何管理空闲页"><a href="#如何管理空闲页" class="header-anchor">#</a> 如何管理空闲页</h3> <p>多次使用后，空闲页肯定分布不来连续，当添加新的缓存页时，为了能够快速定位空闲页，MySQL将空闲页对应的控制块使用链表连接起来，称为空闲链表（和操作系统内出管理有点像）</p> <img src="/assets/img/freelist.drawio.86ddc0c2.png" alt="img"> <p>头节点保安链表的头节点，尾节点，链表包含控制头数量，链表节点包含控制块地址，并且双向链表</p> <p>当磁盘中加载数据页时就从空闲链表取出一个空闲页，补充空闲页控制块信息，然后从链表中移除。</p> <h3 id="如何管理脏页"><a href="#如何管理脏页" class="header-anchor">#</a> 如何管理脏页</h3> <p>设计出Flush链表，和空闲链表差不多，只是控制块对应的是脏页</p> <img src="/assets/img/Flush.drawio.09a6395c.png" alt="img"> <h3 id="buffer-pool结构总结"><a href="#buffer-pool结构总结" class="header-anchor">#</a> Buffer Pool结构总结</h3> <img src="/assets/img/bufferpoll_page.2f058b47.png" alt="img" style="zoom:80%;"> <ul><li>Free Page（空闲页），表示此页未被使用，位于 Free 链表；</li> <li>Clean Page（干净页），表示此页已被使用，但是页面未发生修改，位于LRU 链表。</li> <li>Dirty Page（脏页），表示此页「已被使用」且「已经被修改」，其数据和磁盘上的数据已经不一致。当脏页上的数据写入磁盘后，内存数据和磁盘数据一致，那么该页就变成了干净页。脏页同时存在于 LRU 链表和 Flush 链表。</li></ul> <h3 id="如何提高缓存命中率"><a href="#如何提高缓存命中率" class="header-anchor">#</a> 如何提高缓存命中率</h3> <p>MySQL并没有使用简单的LRU算法（预读失败，Bufffer Pool污染）</p> <p>预读失败：MySQL 是这样做的，它改进了 LRU 算法，将 LRU 划分了 2 个区域：<strong>old 区域 和 young 区域</strong>。</p> <p>young 区域在 LRU 链表的前半部分，old 区域则是在后半部分，如下图：</p> <img src="/assets/img/26.1a75786a.png" alt="img"> <p><strong>划分这两个区域后，预读的页就只需要加入到 old 区域的头部，当页被真正访问的时候，才将页插入 young 区域的头部</strong>。如果预读的页一直没有被访问，就会从 old 区域移除，这样就不会影响 young 区域中的热点数据。</p> <p>buffer污染：MySQL 是这样做的，进入到 young 区域条件增加了一个<strong>停留在 old 区域的时间判断</strong>。</p> <p>在对某个处在 old 区域的缓存页进行第一次访问时，就在它对应的控制块中记录下来这个访问时间：</p> <ul><li>如果后续的访问时间与第一次访问的时间<strong>在某个时间间隔内</strong>，那么<strong>该缓存页就不会被从 old 区域移动到 young 区域的头部</strong>；</li> <li>如果后续的访问时间与第一次访问的时间<strong>不在某个时间间隔内</strong>，那么<strong>该缓存页移动到 young 区域的头部</strong>；</li></ul> <p>这个间隔时间是由 <code>innodb_old_blocks_time</code> 控制的，默认是 1000 ms。</p> <p>只有同时满足「被访问」与「在 old 区域停留时间超过 1 秒」两个条件，才会被插入到 young 区域头部</p> <p>另外，MySQL 针对 young 区域其实做了一个优化，为了防止 young 区域节点频繁移动到头部。young 区域前面 1/4 被访问不会移动到链表头部，只有后面的 3/4被访问了才会。</p> <h3 id="脏页的刷盘时机"><a href="#脏页的刷盘时机" class="header-anchor">#</a> 脏页的刷盘时机</h3> <blockquote><p>InnoDB 的更新操作采用的是 Write Ahead Log 策略，即先写日志，再写入磁盘，通过 redo log 日志让 MySQL 拥有了崩溃恢复能力。即使脏页刷盘时宕机数据也不会丢失</p></blockquote> <p>脏页需要刷入磁盘来保证缓存和磁盘数据一致性，为了提高效率一般进行批量刷盘</p> <ul><li>当 redo log 日志满了的情况下，会主动触发脏页刷新到磁盘；</li> <li>Buffer Pool 空间不足时，需要将一部分数据页淘汰掉，如果淘汰的是脏页，需要先将脏页同步到磁盘；</li> <li>MySQL 认为空闲时，后台线程会定期将适量的脏页刷入到磁盘；</li> <li>MySQL 正常关闭之前，会把所有的脏页刷入到磁盘；</li></ul> <h2 id="mysql主从复制"><a href="#mysql主从复制" class="header-anchor">#</a> MySQL主从复制</h2> <p>MySQL主从复制依赖于binLog实现，复制的过程就是主节点将自己的binLog传输给从节点。</p> <img src="/assets/img/22.65e93c98.png"> <ul><li>MySQL 主库在收到客户端提交事务的请求之后，会先写入 binlog，再提交事务，更新存储引擎中的数据，事务提交完成后，返回给客户端“操作成功”的响应。</li> <li>从库会创建一个专门的 I/O 线程，连接主库的 log dump 线程，来接收主库的 binlog 日志，再把 binlog 信息写入 relay log 的中继日志里，再返回给主库“复制成功”的响应。</li> <li>从库会创建一个用于回放 binlog 的线程，去读 relay log 中继日志，然后回放 binlog 更新存储引擎中的数据，最终实现主从的数据一致性。</li></ul> <p>在完成主从复制之后，你就可以在写数据时只写主库，在读数据时只读从库，这样即使写请求会锁表或者锁记录，也不会影响读请求的执行。分担主节点压力。</p> <h4 id="mysql主从复制模型"><a href="#mysql主从复制模型" class="header-anchor">#</a> MySQL主从复制模型</h4> <ul><li><strong>同步复制</strong>：MySQL 主库提交事务的线程要等待所有从库的复制成功响应，才返回客户端结果。这种方式在实际项目中，基本上没法用，原因有两个：一是性能很差，因为要复制到所有节点才返回响应；二是可用性也很差，主库和所有从库任何一个数据库出问题，都会影响业务。</li> <li><strong>异步复制</strong>（默认模型）：MySQL 主库提交事务的线程并不会等待 binlog 同步到各从库，就返回客户端结果。这种模式一旦主库宕机，数据就会发生丢失。</li> <li><strong>半同步复制</strong>：MySQL 5.7 版本之后增加的一种复制方式，介于两者之间，事务线程不用等待所有的从库复制成功响应，只要一部分复制成功响应回来就行，比如一主二从的集群，只要数据成功复制到任意一个从库上，主库的事务线程就可以返回给客户端。这种半同步复制的方式，兼顾了异步复制和同步复制的优点，即使出现主库宕机，至少还有一个从库有最新的数据，不存在数据丢失的风险。</li></ul> <h2 id="mysql数据迁移"><a href="#mysql数据迁移" class="header-anchor">#</a> MySQL数据迁移</h2> <h3 id="需求背景"><a href="#需求背景" class="header-anchor">#</a> 需求背景</h3> <p>随着业务的不断发展，系统的访问量很高，数据也越来越多，这时就需要进行数据库的扩容</p> <p>数据迁移过程需要保证：</p> <ol><li>迁移后数据准确不丢失</li> <li>不影响用户体验</li> <li>迁移后的性能和稳定性</li></ol> <h3 id="方案"><a href="#方案" class="header-anchor">#</a> 方案</h3> <h4 id="挂从库"><a href="#挂从库" class="header-anchor">#</a> 挂从库</h4> <ol><li>在主库上建一个从库，数据开始向从库同步</li> <li>数据同步完成后在用户流量少的时间进行停机，防止新的记录，保证主从一致性，最后将从库升级为主库</li> <li>重新启动服务</li></ol> <h4 id="双写"><a href="#双写" class="header-anchor">#</a> 双写</h4> <ol><li>更改业务逻辑。在对数据增删改的地方同时操作老库和新库</li> <li>开启双写，老库和新库同时写入。更新操作新库没有记录就从老库中获取，为了保证性能可使用消息队列异步更新到新库</li> <li>利用脚本程序，将开启双写后的某一时间戳之前的的老数据迁移到新库，并且记录日志用于异常和恢复</li> <li>通过脚本程序进行数据校验。</li> <li>开启双读，将小部分流量切入到新库</li> <li>读流量全部切入到新库后关闭老库写入</li> <li>迁移完成去掉双写双读的业务代码</li></ol> <img src="data:image/png;base64,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" alt="img" style="zoom:150%;"> <h4 id="数据同步工具"><a href="#数据同步工具" class="header-anchor">#</a> 数据同步工具</h4> <p>Canal，DataBus。</p> <img src="data:image/png;base64,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" alt="img" style="zoom:150%;"> <ol><li>Canal模拟mysql slave的交互协议，把自己伪装成MySQL的从库</li> <li>向mysql master发送dump协议</li> <li>mysql master收到dump协议，发送bin log给canal</li> <li>canal解析bin log，并进行数据处理</li></ol> <p>流程：</p> <ol><li>代码准备。准备Canal代码，解析binary log字节流对象，并把解析好的用户数据写入新库。</li> <li>运行Canal代码，开始增量数据（线上产生的新数据）从老库到新库的同步。</li> <li>利用脚本程序，将某一时间戳之前的老数据迁移到新库。注意：1，时间戳一定要选择开始运行Canal程序后的时间点（比如运行Canal代码后10分钟的时间点），避免部分老数据被漏掉；3，迁移过程一定要记录日志，尤其是错误日志，如果有些记录写入失败，我们可以通过日志恢复数据，以此来保证新老库的数据一致。</li> <li>通过脚本程序检验数据，看新库数据是否准确以及有没有漏掉的数据</li> <li>数据校验没问题后，开启双读，起初给新库放少部分流量，新库和老库同时读取。由于延时问题，新库和老库可能会有少量数据记录不一致的情况，所以新库读不到时需要再读一遍老库。逐步将读流量切到新库，相当于灰度上线的过程。遇到问题可以及时把流量切回老库</li> <li>读流量全部切到新库后，将写入流量切到新库（可以在代码里加上热配置开关。注：由于切换过程Canal程序还在运行，仍然能够获取老库的数据变化并同步到新库，所以切换过程不会导致部分老库数据无法同步新库的情况）</li> <li>关闭Canal程序</li> <li>迁移完成。</li></ol> <h2 id="mysql扩容方案"><a href="#mysql扩容方案" class="header-anchor">#</a> MySQL扩容方案</h2> <h4 id="常规方案"><a href="#常规方案" class="header-anchor">#</a> ** 常规方案**</h4> <p>如果增加的节点数和扩容操作没有规划，那么绝大部分数据所属的分片都有变化，需要在分片间迁移：</p> <ul><li>预估迁移耗时，发布停服公告；</li> <li>停服(用户无法使用服务)，使用事先准备的迁移脚本，进行数据迁移；</li> <li>修改为新的分片规则；</li> <li>启动服务器。</li></ul> <h3 id="免迁移扩容"><a href="#免迁移扩容" class="header-anchor">#</a> 免迁移扩容</h3> <p>采用双倍扩容策略，避免数据迁移。扩容前每个节点的数据，有一半要迁移至一个新增节点中，对应关系比较简单。 具体操作如下(假设已有 2 个节点 A/B，要双倍扩容至 A/A2/B/B2 这 4 个节点)：</p> <ul><li>无需停止应用服务器；</li> <li>新增两个数据库 A2/B2 作为从库，设置主从同步关系为：A=&gt;A2、B=&gt;B2，直至主从数据同步完毕(早期数据可手工同步)；</li> <li>调整分片规则并使之生效： 原 <code>ID%2=0 =&gt; A</code> 改为 <code>ID%4=0 =&gt; A, ID%4=2 =&gt; A2</code>； 原 <code>ID%2=1 =&gt; B</code> 改为 <code>ID%4=1 =&gt; B, ID%4=3 =&gt; B2</code>。</li> <li>解除数据库实例的主从同步关系，并使之生效；</li> <li>此时，四个节点的数据都已完整，只是有冗余(多存了和自己配对的节点的那部分数据)，择机清除即可(过后随时进行，不影响业务)。</li></ul> <h2 id="相关连接"><a href="#相关连接" class="header-anchor">#</a> 相关连接</h2> <p><a href="https://www.51cto.com/article/743212.html" target="_blank" rel="noopener noreferrer">Innodb的RR到底有没有解决幻读？看不懂你打我！-innodb解决了幻读 (51cto.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token keyword">public</span> stati <span class="token keyword">boolean</span> <span class="token function">isIsomorphic</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token class-name">String</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//example: s:&quot;add&quot; t:&quot;egg&quot;; s:&quot;adm&quot;,t:&quot;egg&quot;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> t<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">//建立s和t的字符映射关系</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">,</span><span class="token class-name">Character</span><span class="token punctuation">&gt;</span></span> map<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//遍历s</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 判断map存在是个存在key，表明是否已经对该字符建立过映射</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment">//查看已经建立的映射的值和t对应位置的字符是否相同</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span>t<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">// 不相同说明又建立了一层对应关系</span>
                    <span class="token comment">// 即s中的一个字符与t中的两个字符建立了映射关系</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//直接判断下一个字符</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 判断当前字符对应的t中的字符已经和s前面的某个字符建立过映射关系</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsValue</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">//建立s,t中对应位置的映射关系</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>t<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/pages/数据库/Redis.html">
        Redis
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.347fa917.js" defer></script><script src="/assets/js/4.4e440976.js" defer></script><script src="/assets/js/3.4c8c30ea.js" defer></script>
  </body>
</html>
